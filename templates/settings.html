{% extends "layout.html" %}
{% block content %}
<div class="mdc-card page-card centered">
  <header class="card-header">
    <p class="card-header-title">Settings</p>
  </header>
  <div class="card-content">
    <nav class="buttons tab-buttons mb-4" id="settingsTabs">
      <button type="button" class="mdc-button mdc-button--raised is-active" data-target="generalSettings">General</button>
      <button type="button" class="mdc-button mdc-button--raised" data-target="exportSettings">Export</button>
      <button type="button" class="mdc-button mdc-button--raised" data-target="duplicateSettings">Duplicates</button>
      <button type="button" class="mdc-button mdc-button--raised" data-target="skuSettings">SKUs</button>
    </nav>
    <form method="post" enctype="multipart/form-data">
    <div id="generalSettings" class="tab-pane">
      <div class="box mb-4">
        <h3 class="title is-6 mb-3">Application</h3>
        <div class="field mb-4">
          <label class="label">Application logo</label>
          {% if app_logo_path %}
          <img src="{{ url_for('logo') }}" alt="logo" style="max-height:3rem;" class="mb-2">
          {% endif %}
          <input class="input" type="file" name="app_logo" accept="image/*">
        </div>
        <div class="field mb-4">
          <label class="label">Application title</label>
          <input class="input" type="text" name="app_title" value="{{ app_title }}">
        </div>
      </div>
      <div class="box mb-4">
        <h3 class="title is-6 mb-3">Appearance</h3>
        <div class="field mb-2 is-flex is-align-items-center">
          <label class="label mr-2">Theme</label>
          <div class="select">
            <select id="themeSelect">
              <option value="" {% if not active_theme %}selected{% endif %}>Custom</option>
              <option value="ocean" {% if active_theme == 'ocean' %}selected{% endif %}>Ocean</option>
              <option value="orchid" {% if active_theme == 'orchid' %}selected{% endif %}>Orchid</option>
              <option value="codex" {% if active_theme == 'codex' %}selected{% endif %}>Codex</option>
              <option value="midnight" {% if active_theme == 'midnight' %}selected{% endif %}>Midnight</option>
            </select>
          </div>
        </div>
        <div id="customThemeColors" class="form-grid color-grid">
          <div class="field mb-2">
            <label class="label">Primary color</label>
            <input class="input color-input" type="color" name="theme_primary" value="{{ theme_primary }}">
          </div>
          <div class="field mb-2">
            <label class="label">Highlight color</label>
            <input class="input color-input" type="color" name="theme_highlight" value="{{ theme_highlight }}">
          </div>
          <div class="field mb-2">
            <label class="label">Background color</label>
            <input class="input color-input" type="color" name="theme_background" value="{{ theme_background }}">
          </div>
          <div class="field mb-2">
            <label class="label">Text color</label>
            <input class="input color-input" type="color" name="theme_text" value="{{ theme_text }}">
          </div>
        </div>
      </div>
    </div>
    <div id="exportSettings" class="tab-pane is-hidden">
      <div class="box mb-4">
        <h3 class="title is-5 mb-3">Branding</h3>
        <div class="field mb-4">
          <label class="label">Branding logo</label>
          {% if logo_path %}
          <img src="{{ url_for('branding_logo') }}" alt="logo" style="max-height:3rem;" class="mb-2">
          {% endif %}
          <input class="input" type="file" name="logo" accept="image/*">
        </div>
        <div class="field mb-4">
          <label class="label">Report title</label>
          <input class="input" type="text" name="report_title" value="{{ report_title }}">
        </div>
        <div class="field mb-4">
          <label class="label">Branding text</label>
          <input class="input" type="text" name="branding" value="{{ branding }}">
        </div>
        <div class="form-grid color-grid">
          <div class="field mb-4">
            <label class="label">Primary color</label>
            <input class="input color-input" type="color" name="primary_color" value="{{ primary_color }}">
          </div>
          <div class="field mb-4">
            <label class="label">Highlight color</label>
            <input class="input color-input" type="color" name="highlight_color" value="{{ highlight_color }}">
          </div>
        </div>
      </div>
      <div class="box mb-4">
        <h3 class="title is-5 mb-3">Defaults</h3>
        <div class="field mb-4">
          <label class="label">Default month for exports</label>
          <div class="select">
            <select name="default_month">
              <option value="" {% if not default_month %}selected{% endif %}>Last full month</option>
              {% for m in months %}
              <option value="{{ m.num }}" {% if m.num == default_month %}selected{% endif %}>{{ m.name }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
      </div>
      <div class="box mb-4">
        <h3 class="title is-5 mb-3">Monthly reports</h3>
        <div class="field mb-4">
          <label class="switch-label">
            <input type="checkbox" class="switch" name="include_month_summary" {% if include_month_summary %}checked{% endif %}>
            <span>Last full month by sales type</span>
          </label>
        </div>
        <div class="field mb-4">
          <label class="switch-label">
            <input type="checkbox" class="switch" name="include_month_details" {% if include_month_details %}checked{% endif %}>
            <span>Detailed by type</span>
          </label>
        </div>
        <div id="detailTypesField" class="field mb-4" {% if not include_month_details %}style="display:none"{% endif %}>
          <label class="label">Types for details</label>
          <div>
            <label class="switch-label mr-2 mt-1">
              <input type="checkbox" class="switch" id="detailAll" {% if detail_types_all %}checked{% endif %}>
              <span>All</span>
            </label>
            <div id="detailTypeOptions" style="{% if detail_types_all %}display:none{% endif %}">
              {% for cat in categories %}
              <label class="switch-label mr-2 mt-1">
                <input type="checkbox" class="switch detail-type" name="detail_types" value="{{ cat }}" {% if cat in detail_types %}checked{% endif %}>
                <span>{{ labels[cat] }}</span>
              </label>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>
      <div class="box mb-4">
        <h3 class="title is-5 mb-3">Yearly reports</h3>
        <div class="field mb-4">
          <label class="switch-label">
            <input type="checkbox" class="switch" name="include_year_overall" {% if include_year_overall %}checked{% endif %}>
            <span>Overall sales by month</span>
          </label>
        </div>
        <div class="field mb-4">
          <label class="switch-label">
            <input type="checkbox" class="switch" name="include_year_summary" {% if include_year_summary %}checked{% endif %}>
            <span>Yearly summary by type</span>
          </label>
        </div>
        <div class="field mb-4">
          <label class="switch-label">
            <input type="checkbox" class="switch" name="include_shopify" {% if include_shopify %}checked{% endif %}>
            <span>Shopify income tables</span>
          </label>
        </div>
      </div>
    </div>
    <div id="duplicateSettings" class="tab-pane is-hidden">
      <div class="box mb-4">
        <h3 class="title is-5 mb-3">Duplicate handling</h3>
        <div class="field mb-4">
          <label class="label">Default action</label>
          <div class="select">
            <select name="dup_action">
              <option value="review" {% if dup_action == 'review' %}selected{% endif %}>Review manually</option>
              <option value="shopify" {% if dup_action == 'shopify' %}selected{% endif %}>Keep Shopify</option>
              <option value="qbo" {% if dup_action == 'qbo' %}selected{% endif %}>Keep QBO</option>
              <option value="both" {% if dup_action == 'both' %}selected{% endif %}>Keep both</option>
            </select>
          </div>
        </div>
      </div>
    </div>
    <button id="saveSettingsBtn" type="submit" class="mdc-button mdc-button--raised">Save</button>
    </form>
    <div id="skuSettings" class="tab-pane is-hidden">
      <div class="box mb-4">
        <h3 class="title is-5 mb-3">SKU Map File</h3>
        <div class="is-flex is-align-items-center">
          <a class="mdc-button mdc-button--raised mr-2" href="{{ url_for('export_sku_map') }}">Export</a>
          <form id="importSkuForm" method="post" enctype="multipart/form-data" action="{{ url_for('import_sku_map') }}" class="is-inline-block">
            <input id="skuFileInput" class="is-hidden" type="file" name="sku_file" accept=".csv,.xls,.xlsx" required hidden>
            <button id="importSkuBtn" type="button" class="mdc-button mdc-button--raised">Import</button>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
<script>
  const saveBtn = document.getElementById('saveSettingsBtn');
  if(saveBtn){
    const active = document.querySelector('#settingsTabs .is-active');
    if(active && active.dataset.target === 'skuSettings') saveBtn.style.display = 'none';
  }
  document.querySelectorAll('#settingsTabs button').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('#settingsTabs button').forEach(b => b.classList.remove('is-active'));
      btn.classList.add('is-active');
      document.querySelectorAll('.tab-pane').forEach(p => p.classList.add('is-hidden'));
      document.getElementById(btn.dataset.target).classList.remove('is-hidden');
      if(saveBtn){
        saveBtn.style.display = btn.dataset.target === 'skuSettings' ? 'none' : '';
      }
    });
  });
  const importBtn = document.getElementById('importSkuBtn');
  const importInput = document.getElementById('skuFileInput');
  if(importBtn && importInput){
    importBtn.addEventListener('click', () => importInput.click());
    importInput.addEventListener('change', () => {
      if(importInput.files.length) document.getElementById('importSkuForm').submit();
    });
  }
  const themes = {
    ocean: {primary: "#1976d2", highlight: "#bbdefb", background: "#f8f9fa", text: "#363636"},
    orchid: {primary: "#9c27b0", highlight: "#f3e5f5", background: "#ffffff", text: "#363636"},
    codex: {primary: "#1976d2", highlight: "#161b22", background: "#0d1117", text: "#c9d1d9"},
    midnight: {primary: "#90caf9", highlight: "#0d47a1", background: "#121212", text: "#e0e0e0"}
  };
  function applyTheme(theme){
    if(!theme) return;
    document.querySelector('input[name="theme_primary"]').value = theme.primary;
    document.querySelector('input[name="theme_highlight"]').value = theme.highlight;
    document.querySelector('input[name="theme_background"]').value = theme.background;
    document.querySelector('input[name="theme_text"]').value = theme.text;
  }
  const themeSelect = document.getElementById("themeSelect");
  const customColors = document.getElementById("customThemeColors");
  function toggleCustomColors(){
    if(customColors) customColors.style.display = themeSelect && themeSelect.value ? 'none' : '';
  }
  if(themeSelect){
    themeSelect.addEventListener("change", () => {
      applyTheme(themes[themeSelect.value]);
      toggleCustomColors();
    });
    toggleCustomColors();
  }
  const detailsCb = document.querySelector('input[name="include_month_details"]');
  const detailsField = document.getElementById("detailTypesField");
  const allCb = document.getElementById("detailAll");
  const typeWrap = document.getElementById("detailTypeOptions");
  function toggleDetails(){
    if (detailsField) detailsField.style.display = detailsCb && detailsCb.checked ? '' : 'none';
  }
  function toggleAll(){
    if(!allCb || !typeWrap) return;
    if(allCb.checked){
      typeWrap.style.display = 'none';
      typeWrap.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
    } else {
      typeWrap.style.display = '';
    }
  }
  if (detailsCb){
    detailsCb.addEventListener('change', toggleDetails);
    toggleDetails();
  }
  if(allCb){
    allCb.addEventListener('change', toggleAll);
    toggleAll();
  }
</script>
{% endblock %}
