{% extends "layout.html" %}
{% block content %}
<div class="mdc-card page-card">
  <header class="card-header">
    <p class="card-header-title">Settings</p>
  </header>
  <div class="card-content">
    <nav class="buttons tab-buttons mb-4" id="settingsTabs">
      <button type="button" class="mdc-button mdc-button--raised is-active" data-target="generalSettings">General</button>
      <button type="button" class="mdc-button mdc-button--raised" data-target="exportSettings">Export</button>
      <button type="button" class="mdc-button mdc-button--raised" data-target="skuSettings">SKUs</button>
    </nav>
    <form method="post" enctype="multipart/form-data">
    <div id="generalSettings" class="tab-pane">
      <div class="field mb-4">
        <label class="label">Application title</label>
        <input class="input" type="text" name="app_title" value="{{ app_title }}">
      </div>
    </div>
    <div id="exportSettings" class="tab-pane is-hidden">
      <div class="box mb-4">
        <h3 class="title is-5 mb-3">Branding</h3>
        <div class="field mb-4">
          <label class="label">Branding logo</label>
          {% if logo_path %}
          <img src="{{ url_for('branding_logo') }}" alt="logo" style="max-height:3rem;" class="mb-2">
          {% endif %}
          <input class="input" type="file" name="logo" accept="image/*">
        </div>
        <div class="field mb-4">
          <label class="label">Report title</label>
          <input class="input" type="text" name="report_title" value="{{ report_title }}">
        </div>
        <div class="field mb-4">
          <label class="label">Branding text</label>
          <input class="input" type="text" name="branding" value="{{ branding }}">
        </div>
        <div class="columns">
          <div class="column field mb-4">
            <label class="label">Primary color</label>
            <input class="input" type="color" name="primary_color" value="{{ primary_color }}">
          </div>
          <div class="column field mb-4">
            <label class="label">Highlight color</label>
            <input class="input" type="color" name="highlight_color" value="{{ highlight_color }}">
          </div>
        </div>
      </div>
      <div class="box mb-4">
        <h3 class="title is-5 mb-3">Defaults</h3>
        <div class="field mb-4">
          <label class="label">Default month for exports</label>
          <div class="select">
            <select name="default_month">
              <option value="" {% if not default_month %}selected{% endif %}>Last full month</option>
              {% for m in months %}
              <option value="{{ m.num }}" {% if m.num == default_month %}selected{% endif %}>{{ m.name }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
      </div>
      <div class="box mb-4">
        <h3 class="title is-5 mb-3">Monthly reports</h3>
        <div class="field mb-4">
          <label class="switch-label">
            <input type="checkbox" class="switch" name="include_month_summary" {% if include_month_summary %}checked{% endif %}>
            <span>Last full month by sales type</span>
          </label>
        </div>
        <div class="field mb-4">
          <label class="switch-label">
            <input type="checkbox" class="switch" name="include_month_details" {% if include_month_details %}checked{% endif %}>
            <span>Detailed by type</span>
          </label>
        </div>
        <div id="detailTypesField" class="field mb-4" {% if not include_month_details %}style="display:none"{% endif %}>
          <label class="label">Types for details</label>
          <div>
            <label class="switch-label mr-2 mt-1">
              <input type="checkbox" class="switch" id="detailAll" {% if detail_types_all %}checked{% endif %}>
              <span>All</span>
            </label>
            <div id="detailTypeOptions" style="{% if detail_types_all %}display:none{% endif %}">
              {% for cat in categories %}
              <label class="switch-label mr-2 mt-1">
                <input type="checkbox" class="switch detail-type" name="detail_types" value="{{ cat }}" {% if cat in detail_types %}checked{% endif %}>
                <span>{{ labels[cat] }}</span>
              </label>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>
      <div class="box mb-4">
        <h3 class="title is-5 mb-3">Yearly reports</h3>
        <div class="field mb-4">
          <label class="switch-label">
            <input type="checkbox" class="switch" name="include_year_overall" {% if include_year_overall %}checked{% endif %}>
            <span>Overall sales by month</span>
          </label>
        </div>
        <div class="field mb-4">
          <label class="switch-label">
            <input type="checkbox" class="switch" name="include_year_summary" {% if include_year_summary %}checked{% endif %}>
            <span>Yearly summary by type</span>
          </label>
        </div>
        <div class="field mb-4">
          <label class="switch-label">
            <input type="checkbox" class="switch" name="include_shopify" {% if include_shopify %}checked{% endif %}>
            <span>Shopify income tables</span>
          </label>
        </div>
      </div>
    </div>
      <button type="submit" class="mdc-button mdc-button--raised">Save</button>
    </form>
    <div id="skuSettings" class="tab-pane is-hidden">
      <div class="box mb-4">
        <h3 class="title is-5 mb-3">Export SKU map</h3>
        <a class="mdc-button mdc-button--raised" href="{{ url_for('export_sku_map') }}">Download CSV</a>
      </div>
      <div class="box mb-4">
        <h3 class="title is-5 mb-3">Import SKU map</h3>
        <form method="post" enctype="multipart/form-data" action="{{ url_for('import_sku_map') }}">
          <div class="field mb-4">
            <label class="label">SKU map file</label>
            <input class="input" type="file" name="sku_file" accept=".csv,.xls,.xlsx" required>
          </div>
          <button type="submit" class="mdc-button mdc-button--raised">Import</button>
        </form>
      </div>
    </div>
  </div>
</div>
<script>
  document.querySelectorAll('#settingsTabs button').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('#settingsTabs button').forEach(b => b.classList.remove('is-active'));
      btn.classList.add('is-active');
      document.querySelectorAll('.tab-pane').forEach(p => p.classList.add('is-hidden'));
      document.getElementById(btn.dataset.target).classList.remove('is-hidden');
    });
  });
  const detailsCb = document.querySelector('input[name="include_month_details"]');
  const detailsField = document.getElementById('detailTypesField');
  const allCb = document.getElementById('detailAll');
  const typeWrap = document.getElementById('detailTypeOptions');
  function toggleDetails(){
    if (detailsField) detailsField.style.display = detailsCb && detailsCb.checked ? '' : 'none';
  }
  function toggleAll(){
    if(!allCb || !typeWrap) return;
    if(allCb.checked){
      typeWrap.style.display = 'none';
      typeWrap.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
    } else {
      typeWrap.style.display = '';
    }
  }
  if (detailsCb){
    detailsCb.addEventListener('change', toggleDetails);
    toggleDetails();
  }
  if(allCb){
    allCb.addEventListener('change', toggleAll);
    toggleAll();
  }
</script>
{% endblock %}
