{% extends "layout.html" %}
{% block content %}
<div class="mdc-card page-card">
  <div class="card-content">
    <h2 class="title is-4 mb-4">SKU alias mapping</h2>
    <nav class="buttons tab-buttons mb-4" id="mapTabs">
      <button type="button" class="mdc-button mdc-button--raised is-active" data-target="map">Unmapped ({{ grouped|length }})</button>
      <button type="button" class="mdc-button mdc-button--raised" data-target="mapped">Mapped ({{ mapped|length }})</button>
      <button type="button" class="mdc-button mdc-button--raised" data-target="merged">Merged ({{ merged|length }})</button>
      <button type="button" class="mdc-button mdc-button--raised" data-target="sug">Suggestions ({{ suggestions|length }})</button>
    </nav>
    <section id="map" class="tab-pane">
      <input type="text" id="searchBox" class="input mb-4" placeholder="Search SKUs and aliases">
      <form method="POST">
        <input type="hidden" id="merge_target" name="merge_target" value="">
        {% for entry in grouped %}
        <div class="mdc-card sku-card" data-canonical="{{ entry.canonical }}">
          <div class="card-content">
            <div class="field is-flex is-align-items-center mb-2">
              <label class="label mb-0 mr-1">SKU</label>
              <strong>{{ entry.canonical }}</strong>
              <input type="hidden" name="canonical_{{ loop.index0 }}" value="{{ entry.canonical }}">
            </div>
            <div class="columns is-vcentered sku-row">
              <div class="column is-narrow merge-col">
                <input id="merge_{{ loop.index0 }}" class="switch merge-check" type="checkbox" name="select_{{ loop.index0 }}" value="{{ entry.canonical }}">
                <label for="merge_{{ loop.index0 }}">Merge</label>
                <span class="target-wrap is-hidden">
                  <input id="target_{{ loop.index0 }}" class="switch target-check" type="checkbox" data-value="{{ entry.canonical }}">
                  <label for="target_{{ loop.index0 }}">Parent</label>
                </span>
              </div>
              <div class="column is-narrow">
                <div class="field is-flex is-align-items-center">
                  <label class="label mb-0 mr-1">Type</label>
                  <div class="select">
                    <select name="type_{{ loop.index0 }}">
                      <option value="unmapped" {% if entry.type == 'unmapped' %}selected{% endif %}>Unmapped</option>
                      <option value="machine" {% if entry.type == 'machine' %}selected{% endif %}>Machine</option>
                      <option value="detergent_filter_kits" {% if entry.type == 'detergent_filter_kits' %}selected{% endif %}>Detergent & Filter Kits</option>
                      <option value="detergent" {% if entry.type == 'detergent' %}selected{% endif %}>Detergents</option>
                      <option value="filters" {% if entry.type == 'filters' %}selected{% endif %}>Filters</option>
                      <option value="parts" {% if entry.type == 'parts' %}selected{% endif %}>Parts</option>
                      <option value="service" {% if entry.type == 'service' %}selected{% endif %}>Service</option>
                      <option value="shopify" {% if entry.type == 'shopify' %}selected{% endif %}>Shopify</option>
                      <option value="shipping" {% if entry.type == 'shipping' %}selected{% endif %}>Shipping</option>
                    </select>
                  </div>
                </div>
              </div>
              <div class="column is-narrow">
                <div class="field is-flex is-align-items-center">
                  <label class="label mb-0 mr-1">Source</label>
                  <strong>{{ entry.source }}</strong>
                </div>
              </div>
            </div>
            <div class="field alias-field" {% if not entry.aliases %}style="display:none"{% endif %}>
              <label class="label">Aliases</label>
              <input type="hidden" class="alias-input" name="aliases_{{ loop.index0 }}" value="{{ entry.aliases }}">
              <div class="alias-badges mb-1"></div>
            </div>
          </div>
        </div>
        {% endfor %}
        <hr class="my-4">
        <div class="mdc-card sku-card">
          <div class="card-content">
            <div class="field is-flex is-align-items-center mb-2">
              <label class="label mb-0 mr-1">SKU</label>
              <input class="input" name="canonical_new" placeholder="New canonical SKU">
            </div>
            <div class="columns is-vcentered sku-row">
              <div class="column is-narrow">
                <div class="field is-flex is-align-items-center">
                  <label class="label mb-0 mr-1">Type</label>
                  <div class="select">
                    <select name="type_new">
                      <option value="unmapped">Unmapped</option>
                      <option value="machine">Machine</option>
                      <option value="detergent_filter_kits">Detergent & Filter Kits</option>
                      <option value="detergent">Detergents</option>
                      <option value="filters">Filters</option>
                      <option value="parts">Parts</option>
                      <option value="service">Service</option>
                      <option value="shopify">Shopify</option>
                      <option value="shipping">Shipping</option>
                    </select>
                  </div>
                </div>
              </div>
              <div class="column is-narrow">
                <div class="field is-flex is-align-items-center">
                  <label class="label mb-0 mr-1">Source</label>
                  <strong></strong>
                </div>
              </div>
            </div>
            <div class="field alias-field" style="display:none">
              <label class="label">Aliases</label>
              <input type="text" class="input alias-input" name="aliases_new">
              <div class="alias-badges mb-1"></div>
            </div>
          </div>
        </div>
        <div class="buttons mb-5 mt-4">
          <button class="mdc-button mdc-button--raised" type="submit" name="merge" value="1">Merge selected</button>
          <button class="mdc-button mdc-button--raised" type="submit" name="save" value="1">Save changes</button>
        </div>
      </form>
    </section>
    <section id="mapped" class="tab-pane is-hidden">
      {% for entry in mapped %}
      <div class="mdc-card sku-card" data-canonical="{{ entry.canonical }}">
        <div class="card-content">
          <div class="field is-flex is-align-items-center mb-2">
            <label class="label mb-0 mr-1">Parent SKU</label>
            <div class="select">
              <select class="parent-select">
                <option value="{{ entry.canonical }}" selected>{{ entry.canonical }}</option>
                {% for a in entry.aliases.split(',') if a.strip() %}
                <option value="{{ a.strip() }}">{{ a.strip() }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
          <div class="columns is-vcentered sku-row">
            <div class="column is-narrow">
              <div class="field is-flex is-align-items-center">
                <label class="label mb-0 mr-1">Type</label>
                <strong>{{ entry.type }}</strong>
              </div>
            </div>
            <div class="column is-narrow">
              <div class="field is-flex is-align-items-center">
                <label class="label mb-0 mr-1">Source</label>
                <strong>{{ entry.source }}</strong>
              </div>
            </div>
          </div>
          <div class="field alias-field" {% if not entry.aliases %}style="display:none"{% endif %}>
            <label class="label">Aliases</label>
            <div class="alias-badges mb-1">
              {% for a in entry.aliases.split(',') if a.strip() %}
              <span class="tag is-info is-light" data-alias="{{ a.strip() }}">
                {{ a.strip() }}
                <button type="button" class="delete is-small ml-1">×</button>
              </span>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    </section>
    <section id="merged" class="tab-pane is-hidden">
      {% for entry in merged %}
      <div class="mdc-card sku-card" data-canonical="{{ entry.canonical }}">
        <div class="card-content">
          <div class="field is-flex is-align-items-center mb-2">
            <label class="label mb-0 mr-1">Parent SKU</label>
            <div class="select">
              <select class="parent-select">
                <option value="{{ entry.canonical }}" selected>{{ entry.canonical }}</option>
                {% for a in entry.aliases.split(',') if a.strip() %}
                <option value="{{ a.strip() }}">{{ a.strip() }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
          <div class="columns is-vcentered sku-row">
            <div class="column is-narrow">
              <div class="field is-flex is-align-items-center">
                <label class="label mb-0 mr-1">Type</label>
                <strong>{{ entry.type }}</strong>
              </div>
            </div>
            <div class="column is-narrow">
              <div class="field is-flex is-align-items-center">
                <label class="label mb-0 mr-1">Source</label>
                <strong>{{ entry.source }}</strong>
              </div>
            </div>
          </div>
          <div class="field alias-field" {% if not entry.aliases %}style="display:none"{% endif %}>
            <label class="label">Aliases</label>
            <div class="alias-badges mb-1">
              {% for a in entry.aliases.split(',') if a.strip() %}
              <span class="tag is-info is-light" data-alias="{{ a.strip() }}">
                {{ a.strip() }}
                <button type="button" class="delete is-small ml-1">×</button>
              </span>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    </section>
    <section id="sug" class="tab-pane is-hidden">
      {% if suggestions %}
      <form method="POST">
        <div class="table-responsive">
        <table class="table is-fullwidth is-narrow">
          <thead>
            <tr><th></th><th>Keep</th><th>Merge</th><th class="no-wrap">Score</th></tr>
          </thead>
          <tbody>
          {% for s in suggestions %}
          <tr>
            <td class="has-text-centered">
              <input type="checkbox" name="suggest_{{ loop.index0 }}">
            </td>
            <td>{{ s[0] }}<input type="hidden" name="sug_target_{{ loop.index0 }}" value="{{ s[0] }}"></td>
            <td>{{ s[1] }}<input type="hidden" name="sug_merge_{{ loop.index0 }}" value="{{ s[1] }}"></td>
            <td class="no-wrap">{{ (s[2]*100)|round(1) }}%</td>
          </tr>
          {% endfor %}
          </tbody>
        </table>
        </div>
        <button class="mdc-button mdc-button--raised" type="submit" name="merge_suggestions" value="1">Merge selected</button>
      </form>
      {% else %}
      <p>No suggestions available.</p>
      {% endif %}
    </section>
  </div>
</div>
<script>
(function(){
  const active = document.querySelector('#mapTabs .is-active');
  if (active) {
    document.querySelectorAll('.tab-pane').forEach(p => p.classList.add('is-hidden'));
    document.getElementById(active.dataset.target).classList.remove('is-hidden');
  }
  document.querySelectorAll('#mapTabs button').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('#mapTabs button').forEach(b => b.classList.remove('is-active'));
      btn.classList.add('is-active');
      document.querySelectorAll('.tab-pane').forEach(p => p.classList.add('is-hidden'));
      document.getElementById(btn.dataset.target).classList.remove('is-hidden');
      document.querySelectorAll('#mapped .parent-select, #merged .parent-select').forEach(sel => {
        const card = sel.closest('.sku-card');
        refreshParentSelect(card);
      });
    });
  });

  const search = document.getElementById('searchBox');
  if (search) {
    search.addEventListener('input', () => {
      const term = search.value.toLowerCase();
      document.querySelectorAll('#map .sku-card').forEach(card => {
        const can = card.querySelector('input[name^="canonical_"]');
        const alias = card.querySelector('input[name^="aliases_"]');
        if (can && !can.name.endsWith('_new')) {
          let text = can.value.toLowerCase();
          if (alias) text += ' ' + alias.value.toLowerCase();
          card.style.display = text.includes(term) ? '' : 'none';
        }
      });
    });
  }

  function updateTargets(){
    const any = document.querySelector('.merge-check:checked');
    const current = document.querySelector('.target-check:checked');
    document.querySelectorAll('.sku-card').forEach(card => {
      const merge = card.querySelector('.merge-check');
      const wrap = card.querySelector('.target-wrap');
      const t = card.querySelector('.target-check');
      if (merge && wrap && t) {
        const show = any && merge.checked && (!current || t.checked);
        wrap.classList.toggle('is-hidden', !show);
      }
    });
    const hidden = document.getElementById('merge_target');
    if (hidden) hidden.value = current ? current.dataset.value : '';
  }

  function initAliasInput(input){
    const container = input.nextElementSibling;
    const field = input.closest('.alias-field');
    function render(){
      container.innerHTML = '';
      let aliases = Array.from(new Set(input.value.split(',').map(a => a.trim()).filter(Boolean)));
      aliases.forEach(a => {
        const tag = document.createElement('span');
        tag.className = 'tag is-info is-light';
        tag.dataset.alias = a;
        tag.textContent = a;
        const del = document.createElement('button');
        del.type = 'button';
        del.className = 'delete is-small ml-1';
        del.textContent = '×';
        del.addEventListener('click', e => {
          e.stopPropagation();
          aliases = aliases.filter(x => x !== a);
          input.value = aliases.join(', ');
          render();
        });
        tag.appendChild(del);
        container.appendChild(tag);
      });
      if (field) field.style.display = aliases.length ? '' : 'none';
    }
    input.addEventListener('blur', render);
    input.addEventListener('change', render);
    render();
  }

  function initCard(card){
    const cb = card.querySelector('.merge-check');
    if (cb) {
      card.classList.toggle('selected', cb.checked);
      cb.addEventListener('change', () => {
        card.classList.toggle('selected', cb.checked);
        if (!cb.checked) {
          const t = card.querySelector('.target-check');
          if (t && t.checked) t.checked = false;
        }
        if (!document.querySelector('.target-check:checked')) {
          const first = document.querySelector('.merge-check:checked');
          if (first) {
            const check = first.closest('.sku-card').querySelector('.target-check');
            if (check) check.checked = true;
          }
        }
        updateTargets();
      });
    }
    card.querySelectorAll('.target-check').forEach(tc => {
      tc.addEventListener('change', () => {
        if (tc.checked) {
          document.querySelectorAll('.target-check').forEach(o => { if (o !== tc) o.checked = false; });
        }
        updateTargets();
      });
    });
    card.querySelectorAll('.alias-input').forEach(initAliasInput);
    card.addEventListener('click', e => {
      if (e.target.closest('.target-wrap') || e.target.closest('select')) return;
      if (e.target.closest('.merge-check')) return;
      if (e.target.matches('label[for^="merge_"]')) e.preventDefault();
      if (e.target.closest('input') || e.target.closest('button')) return;
      if (cb) { cb.checked = !cb.checked; cb.dispatchEvent(new Event('change')); }
    });
  }

  document.querySelectorAll('.sku-card').forEach(initCard);

  let nextIdx = Math.max(0, ...Array.from(document.querySelectorAll('input[name^="canonical_"]')).map(i => parseInt(i.name.split('_')[1])||0)) + 1;

  const typeOptions = Array.from(document.querySelector('#map select[name^="type_"]').options).map(o => `<option value="${o.value}">${o.textContent}</option>`).join('');

  function createMapCard(idx, canonical, type, source=''){
    const div = document.createElement('div');
    div.className = 'mdc-card sku-card';
    div.dataset.canonical = canonical;
    div.innerHTML = `
      <div class="card-content">
        <div class="field is-flex is-align-items-center mb-2">
          <label class="label mb-0 mr-1">SKU</label>
          <strong>${canonical}</strong>
          <input type="hidden" name="canonical_${idx}" value="${canonical}">
        </div>
        <div class="columns is-vcentered sku-row">
          <div class="column is-narrow merge-col">
            <input id="merge_${idx}" class="switch merge-check" type="checkbox" name="select_${idx}" value="${canonical}">
            <label for="merge_${idx}">Merge</label>
            <span class="target-wrap is-hidden">
              <input id="target_${idx}" class="switch target-check" type="checkbox" data-value="${canonical}">
              <label for="target_${idx}">Parent</label>
            </span>
          </div>
          <div class="column is-narrow">
            <div class="field is-flex is-align-items-center">
              <label class="label mb-0 mr-1">Type</label>
              <div class="select">
                <select name="type_${idx}">${typeOptions}</select>
              </div>
            </div>
          </div>
          <div class="column is-narrow">
            <div class="field is-flex is-align-items-center">
              <label class="label mb-0 mr-1">Source</label>
              <strong>${source}</strong>
            </div>
          </div>
        </div>
        <div class="field alias-field" style="display:none">
          <label class="label">Aliases</label>
          <input type="hidden" class="alias-input" name="aliases_${idx}" value="">
          <div class="alias-badges mb-1"></div>
        </div>
      </div>`;
    div.querySelector(`select[name="type_${idx}"]`).value = type || 'unmapped';
    return div;
  }

  function addMapCard(canonical, type){
    if (document.querySelector(`#map .sku-card[data-canonical="${canonical}"]`)) return;
    const form = document.querySelector('#map form');
    const hr = form.querySelector('hr.my-4');
    const card = createMapCard(nextIdx++, canonical, type);
    form.insertBefore(card, hr);
    initCard(card);
    updateTargets();
  }

  function aliasDeleteHandler(e){
    e.stopPropagation();
    const btn = e.currentTarget;
    const tag = btn.parentElement;
    const alias = tag.dataset.alias;
    const card = btn.closest('.sku-card');
    const canonical = card ? card.dataset.canonical : '';
    if (tag) tag.remove();
    if (!alias || !canonical) return;
    const mapCard = document.querySelector(`#map .sku-card[data-canonical="${canonical}"]`);
    if (mapCard) {
      const input = mapCard.querySelector('.alias-input');
      if (input) {
        let aliases = input.value.split(',').map(a => a.trim()).filter(Boolean);
        aliases = aliases.filter(a => a !== alias);
        input.value = aliases.join(', ');
        input.dispatchEvent(new Event('change'));
      }
      const typeSel = mapCard.querySelector('select[name^="type_"]');
      const typeVal = typeSel ? typeSel.value : 'unmapped';
      addMapCard(alias, typeVal);
    }
    const container = card ? card.querySelector('.alias-badges') : null;
    const field = container ? container.closest('.alias-field') : null;
    if (container && container.children.length === 0) {
      if (field) field.style.display = 'none';
      card.remove();
      const sec = btn.closest('#merged') ? 'merged' : 'mapped';
      const tabBtn = document.querySelector(`#mapTabs button[data-target="${sec}"]`);
      if (tabBtn) {
        const count = document.querySelectorAll(`#${sec} .sku-card`).length;
        tabBtn.textContent = sec.charAt(0).toUpperCase() + sec.slice(1) + ` (${count})`;
      }
    } else {
      refreshParentSelect(card);
    }
  }

  function setupAliasDelete(btn){
    btn.addEventListener('click', aliasDeleteHandler);
  }

  document.querySelectorAll('#merged .alias-badges .delete, #mapped .alias-badges .delete').forEach(setupAliasDelete);

  function refreshParentSelect(card){
    const select = card.querySelector('.parent-select');
    if (!select) return;
    const canonical = card.dataset.canonical;
    const aliases = Array.from(card.querySelectorAll('.alias-badges .tag')).map(t => t.dataset.alias).filter(Boolean);
    select.innerHTML = '';
    [canonical, ...aliases].forEach(v => {
      const opt = document.createElement('option');
      opt.value = v;
      opt.textContent = v;
      if (v === canonical) opt.selected = true;
      select.appendChild(opt);
    });
  }

  function moveCardToTop(card){
    const mappedSection = document.getElementById('mapped');
    const mergedSection = document.getElementById('merged');
    if (card.closest('#mapped')) {
      mappedSection.prepend(card);
    } else if (card.closest('#merged')) {
      mergedSection.prepend(card);
    }
  }

  function changeParent(card, newParent){
    const oldParent = card.dataset.canonical;
    if (newParent === oldParent) return;

    const container = card.querySelector('.alias-badges');
    const field = container ? container.closest('.alias-field') : null;
    const selectedTag = card.querySelector(`.alias-badges [data-alias="${newParent}"]`);
    if (selectedTag) selectedTag.remove();
    if (container) {
      const newTag = document.createElement('span');
      newTag.className = 'tag is-info is-light';
      newTag.dataset.alias = oldParent;
      newTag.textContent = oldParent;
      const delBtn = document.createElement('button');
      delBtn.type = 'button';
      delBtn.className = 'delete is-small ml-1';
      delBtn.textContent = '×';
      newTag.appendChild(delBtn);
      container.prepend(newTag);
      setupAliasDelete(delBtn);
      if (field) field.style.display = '';
    }

    card.dataset.canonical = newParent;
    refreshParentSelect(card);

    document.querySelectorAll(`#mapped .sku-card[data-canonical="${oldParent}"], #merged .sku-card[data-canonical="${oldParent}"]`).forEach(other => {
      if (other === card) return;
      const cont = other.querySelector('.alias-badges');
      const fld = cont ? cont.closest('.alias-field') : null;
      const selTag = other.querySelector(`.alias-badges [data-alias="${newParent}"]`);
      if (selTag) selTag.remove();
      if (cont) {
        const tag = document.createElement('span');
        tag.className = 'tag is-info is-light';
        tag.dataset.alias = oldParent;
        tag.textContent = oldParent;
        const delBtn = document.createElement('button');
        delBtn.type = 'button';
        delBtn.className = 'delete is-small ml-1';
        delBtn.textContent = '×';
        tag.appendChild(delBtn);
        cont.prepend(tag);
        setupAliasDelete(delBtn);
        if (fld) fld.style.display = '';
      }
      other.dataset.canonical = newParent;
      refreshParentSelect(other);
      moveCardToTop(other);
    });

    const typeVal = card.querySelector('.sku-row strong')?.textContent.trim() || 'unmapped';
    const aliasList = Array.from(card.querySelectorAll('.alias-badges .tag')).map(t => t.dataset.alias).filter(Boolean);
    aliasList.unshift(oldParent);
    let mapCard = document.querySelector(`#map .sku-card[data-canonical="${newParent}"]`);
    if (!mapCard) {
      addMapCard(newParent, typeVal);
      mapCard = document.querySelector(`#map .sku-card[data-canonical="${newParent}"]`);
    }
    const input = mapCard.querySelector('.alias-input');
    if (input) {
      input.value = Array.from(new Set(aliasList)).join(', ');
      input.dispatchEvent(new Event('change'));
    }

    const oldMap = document.querySelector(`#map .sku-card[data-canonical="${oldParent}"]`);
    if (oldMap) {
      const oldInput = oldMap.querySelector('.alias-input');
      if (oldInput) {
        let aliases = oldInput.value.split(',').map(a => a.trim()).filter(Boolean);
        aliases = aliases.filter(a => a !== newParent);
        oldInput.value = aliases.join(', ');
        oldInput.dispatchEvent(new Event('change'));
      }
    }

    fetch('/update-parent', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({alias: oldParent, parent: newParent})
    });

    moveCardToTop(card);
  }

  function setupParentSelect(select){
    const card = select.closest('.sku-card');
    refreshParentSelect(card);
    select.addEventListener('change', () => {
      changeParent(card, select.value);
    });
  }

  document.querySelectorAll('#mapped .parent-select, #merged .parent-select').forEach(setupParentSelect);

  updateTargets();
})();
</script>
{% endblock %}
