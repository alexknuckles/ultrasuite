{% extends "layout.html" %}
{% block content %}
<div class="mdc-card page-card">
  <div class="card-content">
    <h2 class="title is-4 mb-4">SKU alias mapping</h2>
    <div class="field mb-4">
      <input type="text" id="searchBox" class="input" placeholder="Search SKUs and aliases">
    </div>
    <nav class="buttons tab-buttons mb-4" id="mapTabs">
      <button type="button" class="mdc-button mdc-button--raised is-active" data-target="all">All ({{ all_count }})</button>
      <button type="button" class="mdc-button mdc-button--raised" data-target="unmapped">Unmapped ({{ grouped|length }})</button>
      <button type="button" class="mdc-button mdc-button--raised" data-target="mapped">Mapped ({{ mapped|length }})</button>
      <button type="button" class="mdc-button mdc-button--raised" data-target="merged">Merged ({{ merged|length }})</button>
    </nav>
    <section id="unmapped" class="tab-pane">
      <form method="POST">
        <input type="hidden" id="merge_target" class="merge-target" name="merge_target" value="">
        {% for entry in grouped %}
        <div class="mdc-card sku-card" data-canonical="{{ entry.canonical }}" data-aliases="{{ entry.aliases }}">
          <div class="card-content">
            <div class="field is-flex is-align-items-center mb-2">
              <label class="label mb-0 mr-1">SKU</label>
              <strong>{{ entry.canonical }}</strong>
              <input type="hidden" name="canonical_{{ loop.index0 }}" value="{{ entry.canonical }}">
            </div>
            <div class="columns is-vcentered sku-row">
              <div class="column is-narrow merge-col">
                <input id="merge_{{ loop.index0 }}" class="switch merge-check" type="checkbox" name="select_{{ loop.index0 }}" value="{{ entry.canonical }}">
                <label for="merge_{{ loop.index0 }}">Merge</label>
                <span class="target-wrap is-hidden">
                  <input id="target_{{ loop.index0 }}" class="switch target-check" type="checkbox" data-value="{{ entry.canonical }}">
                  <label for="target_{{ loop.index0 }}">Parent</label>
                </span>
              </div>
              <div class="column is-narrow">
                <div class="field is-flex is-align-items-center">
                  <label class="label mb-0 mr-1">Type</label>
                  <div class="select">
                    <select name="type_{{ loop.index0 }}">
                      <option value="unmapped" {% if entry.type == 'unmapped' %}selected{% endif %}>Unmapped</option>
                      <option value="machine" {% if entry.type == 'machine' %}selected{% endif %}>Machine</option>
                      <option value="detergent_filter_kits" {% if entry.type == 'detergent_filter_kits' %}selected{% endif %}>Detergent & Filter Kits</option>
                      <option value="detergent" {% if entry.type == 'detergent' %}selected{% endif %}>Detergents</option>
                      <option value="filters" {% if entry.type == 'filters' %}selected{% endif %}>Filters</option>
                      <option value="parts" {% if entry.type == 'parts' %}selected{% endif %}>Parts</option>
                      <option value="service" {% if entry.type == 'service' %}selected{% endif %}>Service</option>
                      <option value="shopify" {% if entry.type == 'shopify' %}selected{% endif %}>Shopify</option>
                      <option value="shipping" {% if entry.type == 'shipping' %}selected{% endif %}>Shipping</option>
                    </select>
                  </div>
                </div>
              </div>
              <div class="column is-narrow">
                <div class="field is-flex is-align-items-center">
                  <label class="label mb-0 mr-1">Source</label>
                  <strong>{{ entry.source }}</strong>
                </div>
              </div>
            </div>
            <div class="field alias-field" {% if not entry.aliases %}style="display:none"{% endif %}>
              <label class="label">Aliases</label>
              <input type="hidden" class="alias-input" name="aliases_{{ loop.index0 }}" value="{{ entry.aliases }}">
              <div class="alias-badges mb-1"></div>
            </div>
          </div>
        </div>
        {% endfor %}
        <hr class="my-4">
        <div class="mdc-card sku-card">
          <div class="card-content">
            <div class="field is-flex is-align-items-center mb-2">
              <label class="label mb-0 mr-1">SKU</label>
              <input class="input" name="canonical_new" placeholder="New canonical SKU">
            </div>
            <div class="columns is-vcentered sku-row">
              <div class="column is-narrow">
                <div class="field is-flex is-align-items-center">
                  <label class="label mb-0 mr-1">Type</label>
                  <div class="select">
                    <select name="type_new">
                      <option value="unmapped">Unmapped</option>
                      <option value="machine">Machine</option>
                      <option value="detergent_filter_kits">Detergent & Filter Kits</option>
                      <option value="detergent">Detergents</option>
                      <option value="filters">Filters</option>
                      <option value="parts">Parts</option>
                      <option value="service">Service</option>
                      <option value="shopify">Shopify</option>
                      <option value="shipping">Shipping</option>
                    </select>
                  </div>
                </div>
              </div>
              <div class="column is-narrow">
                <div class="field is-flex is-align-items-center">
                  <label class="label mb-0 mr-1">Source</label>
                  <strong></strong>
                </div>
              </div>
            </div>
            <div class="field alias-field" style="display:none">
              <label class="label">Aliases</label>
              <input type="text" class="input alias-input" name="aliases_new">
              <div class="alias-badges mb-1"></div>
            </div>
          </div>
        </div>
        <div class="buttons mb-5 mt-4">
          <button class="mdc-button mdc-button--raised" type="submit" name="merge" value="1">Merge selected</button>
        </div>
      </form>
    </section>
    <section id="mapped" class="tab-pane is-hidden">
      <form method="POST">
        <input type="hidden" name="merge_target" value="" class="merge-target">
        {% for entry in mapped %}
        <div class="mdc-card sku-card" data-canonical="{{ entry.canonical }}" data-aliases="{{ entry.aliases }}">
          <div class="card-content">
            <div class="field is-flex is-align-items-center mb-2">
              <label class="label mb-0 mr-1">{% if entry.alias_count > 0 %}Parent SKU{% else %}SKU{% endif %}</label>
            {% if entry.aliases.strip() %}
            <div class="select">
              <select class="parent-select">
                <option value="{{ entry.canonical }}" selected>{{ entry.canonical }}</option>
                {% for a in entry.aliases.split(',') if a.strip() %}
                <option value="{{ a.strip() }}">{{ a.strip() }}</option>
                {% endfor %}
              </select>
            </div>
            {% else %}
            <strong>{{ entry.canonical }}</strong>
            {% endif %}
          </div>
          <div class="columns is-vcentered sku-row">
            <div class="column is-narrow merge-col">
              <input id="merge_m{{ loop.index0 }}" class="switch merge-check" type="checkbox" name="select_m{{ loop.index0 }}" value="{{ entry.canonical }}">
              <label for="merge_m{{ loop.index0 }}">Merge</label>
              <span class="target-wrap is-hidden">
                <input id="target_m{{ loop.index0 }}" class="switch target-check" type="checkbox" data-value="{{ entry.canonical }}">
                <label for="target_m{{ loop.index0 }}">Parent</label>
              </span>
            </div>
            <div class="column is-narrow">
              <div class="field is-flex is-align-items-center">
                <label class="label mb-0 mr-1">Type</label>
                <div class="select">
                  <select class="type-select">
                    <option value="unmapped" {% if entry.type == 'unmapped' %}selected{% endif %}>Unmapped</option>
                    <option value="machine" {% if entry.type == 'machine' %}selected{% endif %}>Machine</option>
                    <option value="detergent_filter_kits" {% if entry.type == 'detergent_filter_kits' %}selected{% endif %}>Detergent & Filter Kits</option>
                    <option value="detergent" {% if entry.type == 'detergent' %}selected{% endif %}>Detergents</option>
                    <option value="filters" {% if entry.type == 'filters' %}selected{% endif %}>Filters</option>
                    <option value="parts" {% if entry.type == 'parts' %}selected{% endif %}>Parts</option>
                    <option value="service" {% if entry.type == 'service' %}selected{% endif %}>Service</option>
                    <option value="shopify" {% if entry.type == 'shopify' %}selected{% endif %}>Shopify</option>
                    <option value="shipping" {% if entry.type == 'shipping' %}selected{% endif %}>Shipping</option>
                  </select>
                </div>
              </div>
            </div>
            <div class="column is-narrow">
              <div class="field is-flex is-align-items-center">
                <label class="label mb-0 mr-1">Source</label>
                <strong>{{ entry.source }}</strong>
              </div>
            </div>
          </div>
          <div class="field alias-field" {% if not entry.aliases %}style="display:none"{% endif %}>
            <label class="label">Aliases</label>
            <div class="alias-badges mb-1">
              {% for a in entry.aliases.split(',') if a.strip() %}
              <span class="tag is-info is-light" data-alias="{{ a.strip() }}">
                {{ a.strip() }}
                <button type="button" class="delete is-small ml-1">×</button>
              </span>
              {% endfor %}
            </div>
          </div>
        </div>
        </div>
        {% endfor %}
        <div class="buttons mb-5 mt-4">
          <button class="mdc-button mdc-button--raised" type="submit" name="merge" value="1">Merge selected</button>
        </div>
      </form>
    </section>
    <section id="merged" class="tab-pane is-hidden">
      {% for entry in merged %}
      <div class="mdc-card sku-card" data-canonical="{{ entry.canonical }}" data-aliases="{{ entry.aliases }}">
        <div class="card-content">
          <div class="field is-flex is-align-items-center mb-2">
            <label class="label mb-0 mr-1">Parent SKU</label>
            {% if entry.aliases.strip() %}
            <div class="select">
              <select class="parent-select">
                <option value="{{ entry.canonical }}" selected>{{ entry.canonical }}</option>
                {% for a in entry.aliases.split(',') if a.strip() %}
                <option value="{{ a.strip() }}">{{ a.strip() }}</option>
                {% endfor %}
              </select>
            </div>
            {% else %}
            <strong>{{ entry.canonical }}</strong>
            {% endif %}
          </div>
          <div class="columns is-vcentered sku-row">
            <div class="column is-narrow">
              <div class="field is-flex is-align-items-center">
                <label class="label mb-0 mr-1">Type</label>
                <div class="select">
                  <select class="type-select">
                    <option value="unmapped" {% if entry.type == 'unmapped' %}selected{% endif %}>Unmapped</option>
                    <option value="machine" {% if entry.type == 'machine' %}selected{% endif %}>Machine</option>
                    <option value="detergent_filter_kits" {% if entry.type == 'detergent_filter_kits' %}selected{% endif %}>Detergent & Filter Kits</option>
                    <option value="detergent" {% if entry.type == 'detergent' %}selected{% endif %}>Detergents</option>
                    <option value="filters" {% if entry.type == 'filters' %}selected{% endif %}>Filters</option>
                    <option value="parts" {% if entry.type == 'parts' %}selected{% endif %}>Parts</option>
                    <option value="service" {% if entry.type == 'service' %}selected{% endif %}>Service</option>
                    <option value="shopify" {% if entry.type == 'shopify' %}selected{% endif %}>Shopify</option>
                    <option value="shipping" {% if entry.type == 'shipping' %}selected{% endif %}>Shipping</option>
                  </select>
                </div>
              </div>
            </div>
            <div class="column is-narrow">
              <div class="field is-flex is-align-items-center">
                <label class="label mb-0 mr-1">Source</label>
                <strong>{{ entry.source }}</strong>
              </div>
            </div>
          </div>
          <div class="field alias-field" {% if not entry.aliases %}style="display:none"{% endif %}>
            <label class="label">Aliases</label>
            <div class="alias-badges mb-1">
              {% for a in entry.aliases.split(',') if a.strip() %}
              <span class="tag is-info is-light" data-alias="{{ a.strip() }}">
                {{ a.strip() }}
                <button type="button" class="delete is-small ml-1">×</button>
              </span>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    </section>
  </div>
</div>
<script>
(function(){
  const active = document.querySelector('#mapTabs .is-active');
  if (active) {
    document.querySelectorAll('.tab-pane').forEach(p => p.classList.add('is-hidden'));
    if (active.dataset.target === 'all') {
      ['unmapped', 'mapped', 'merged'].forEach(id => {
        const sec = document.getElementById(id);
        if (sec) sec.classList.remove('is-hidden');
      });
    } else {
      document.getElementById(active.dataset.target).classList.remove('is-hidden');
    }
  }
  document.querySelectorAll('#mapTabs button').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('#mapTabs button').forEach(b => b.classList.remove('is-active'));
      btn.classList.add('is-active');
      document.querySelectorAll('.tab-pane').forEach(p => p.classList.add('is-hidden'));
      if (btn.dataset.target === 'all') {
        ['unmapped', 'mapped', 'merged'].forEach(id => {
          const sec = document.getElementById(id);
          if (sec) sec.classList.remove('is-hidden');
        });
      } else {
        document.getElementById(btn.dataset.target).classList.remove('is-hidden');
      }
      document.querySelectorAll('#mapped .parent-select, #merged .parent-select').forEach(sel => {
        const card = sel.closest('.sku-card');
        refreshParentSelect(card);
      });
      filterSearch();
    });
  });

  const search = document.getElementById('searchBox');
  function isFiltering(){
    return search && search.value.trim() !== '';
  }
  function isAllTabActive(){
    const btn = document.querySelector('#mapTabs .is-active');
    return btn && btn.dataset.target === 'all';
  }
  function filterSearch(){
    if (!search) return;
    const term = search.value.toLowerCase().trim();
    document.querySelectorAll('.sku-card').forEach(card => {
      const text = (card.dataset.canonical || '') + ' ' + (card.dataset.aliases || '');
      const show = !term || text.toLowerCase().includes(term);
      card.style.display = show ? '' : 'none';
    });
  }
  if (search) {
    search.addEventListener('input', filterSearch);
    filterSearch();
  }

  function updateTargets(){
    const any = document.querySelector('.merge-check:checked');
    const current = document.querySelector('.target-check:checked');
    document.querySelectorAll('.sku-card').forEach(card => {
      const merge = card.querySelector('.merge-check');
      const wrap = card.querySelector('.target-wrap');
      const t = card.querySelector('.target-check');
      if (merge && wrap && t) {
        const show = any && merge.checked && (!current || t.checked);
        wrap.classList.toggle('is-hidden', !show);
      }
    });
    document.querySelectorAll('input.merge-target').forEach(hidden => {
      hidden.value = current ? current.dataset.value : '';
    });
  }

  function initAliasInput(input){
    const container = input.nextElementSibling;
    const field = input.closest('.alias-field');
    const card = input.closest('.sku-card');
    function render(){
      container.innerHTML = '';
      let aliases = Array.from(new Set(input.value.split(',').map(a => a.trim()).filter(Boolean)));
      aliases.forEach(a => {
        const tag = document.createElement('span');
        tag.className = 'tag is-info is-light';
        tag.dataset.alias = a;
        tag.textContent = a;
        const del = document.createElement('button');
        del.type = 'button';
        del.className = 'delete is-small ml-1';
        del.textContent = '×';
        del.addEventListener('click', e => {
          e.stopPropagation();
          aliases = aliases.filter(x => x !== a);
          input.value = aliases.join(', ');
          render();
        });
        tag.appendChild(del);
        container.appendChild(tag);
      });
      if (field) field.style.display = aliases.length ? '' : 'none';
      if (card) card.dataset.aliases = aliases.join(', ');
    }
    input.addEventListener('blur', render);
    input.addEventListener('change', render);
    render();
  }

  function initCard(card){
    const cb = card.querySelector('.merge-check');
    if (cb) {
      card.classList.toggle('selected', cb.checked);
      cb.addEventListener('change', () => {
        card.classList.toggle('selected', cb.checked);
        if (!cb.checked) {
          const t = card.querySelector('.target-check');
          if (t && t.checked) t.checked = false;
        }
        if (!document.querySelector('.target-check:checked')) {
          const first = document.querySelector('.merge-check:checked');
          if (first) {
            const check = first.closest('.sku-card').querySelector('.target-check');
            if (check) check.checked = true;
          }
        }
        updateTargets();
      });
    }
    card.querySelectorAll('.target-check').forEach(tc => {
      tc.addEventListener('change', () => {
        if (tc.checked) {
          document.querySelectorAll('.target-check').forEach(o => { if (o !== tc) o.checked = false; });
        }
        updateTargets();
      });
    });
    card.querySelectorAll('.alias-input').forEach(initAliasInput);
    card.querySelectorAll('select[name^="type_"]').forEach(setupTypeSelect);
    card.addEventListener('click', e => {
      if (e.target.closest('.target-wrap') || e.target.closest('select')) return;
      if (e.target.closest('.merge-check')) return;
      if (e.target.matches('label[for^="merge_"]')) e.preventDefault();
      if (e.target.closest('input') || e.target.closest('button')) return;
      if (cb) { cb.checked = !cb.checked; cb.dispatchEvent(new Event('change')); }
    });
  }

  function setupTypeSelect(sel){
    sel.addEventListener('change', () => {
      const card = sel.closest('.sku-card');
      if (!card) return;
      if (sel.value !== 'unmapped') moveToMapped(card, sel.value);
    });
  }

  document.querySelectorAll('.sku-card').forEach(initCard);
  document.querySelectorAll('#unmapped select[name^="type_"]').forEach(setupTypeSelect);

  let nextIdx = Math.max(0, ...Array.from(document.querySelectorAll('input[name^="canonical_"]')).map(i => parseInt(i.name.split('_')[1])||0)) + 1;

  const typeOptions = Array.from(document.querySelector('#unmapped select[name^="type_"]').options).map(o => `<option value="${o.value}">${o.textContent}</option>`).join('');

  function createMapCard(idx, canonical, type, source=''){
    const div = document.createElement('div');
    div.className = 'mdc-card sku-card';
    div.dataset.canonical = canonical;
    div.dataset.aliases = '';
    div.innerHTML = `
      <div class="card-content">
        <div class="field is-flex is-align-items-center mb-2">
          <label class="label mb-0 mr-1">SKU</label>
          <strong>${canonical}</strong>
          <input type="hidden" name="canonical_${idx}" value="${canonical}">
        </div>
        <div class="columns is-vcentered sku-row">
          <div class="column is-narrow merge-col">
            <input id="merge_${idx}" class="switch merge-check" type="checkbox" name="select_${idx}" value="${canonical}">
            <label for="merge_${idx}">Merge</label>
            <span class="target-wrap is-hidden">
              <input id="target_${idx}" class="switch target-check" type="checkbox" data-value="${canonical}">
              <label for="target_${idx}">Parent</label>
            </span>
          </div>
          <div class="column is-narrow">
            <div class="field is-flex is-align-items-center">
              <label class="label mb-0 mr-1">Type</label>
              <div class="select">
                <select name="type_${idx}">${typeOptions}</select>
              </div>
            </div>
          </div>
          <div class="column is-narrow">
            <div class="field is-flex is-align-items-center">
              <label class="label mb-0 mr-1">Source</label>
              <strong>${source}</strong>
            </div>
          </div>
        </div>
        <div class="field alias-field" style="display:none">
          <label class="label">Aliases</label>
          <input type="hidden" class="alias-input" name="aliases_${idx}" value="">
          <div class="alias-badges mb-1"></div>
        </div>
      </div>`;
    div.querySelector(`select[name="type_${idx}"]`).value = type || 'unmapped';
    return div;
  }

  function addMapCard(canonical, type){
    if (document.querySelector(`#unmapped .sku-card[data-canonical="${canonical}"]`)) return;
    const form = document.querySelector('#unmapped form');
    const hr = form.querySelector('hr.my-4');
    const card = createMapCard(nextIdx++, canonical, type);
    form.insertBefore(card, hr);
    initCard(card);
    updateTargets();
    updateCount('unmapped');
    filterSearch();
  }

  function updateCount(sec){
    const tabBtn = document.querySelector(`#mapTabs button[data-target="${sec}"]`);
    if (tabBtn) {
      let count;
      if (sec === 'all') {
        const set = new Set();
        document.querySelectorAll('.sku-card').forEach(c => set.add(c.dataset.canonical));
        count = set.size;
      } else {
        count = document.querySelectorAll(`#${sec} .sku-card`).length;
      }
      tabBtn.textContent = sec.charAt(0).toUpperCase() + sec.slice(1) + ` (${count})`;
    }
    if (sec !== 'all') {
      const allBtn = document.querySelector('#mapTabs button[data-target="all"]');
      if (allBtn) {
        const set = new Set();
        document.querySelectorAll('.sku-card').forEach(c => set.add(c.dataset.canonical));
        allBtn.textContent = `All (${set.size})`;
      }
    }
  }

  function createDisplayCard(canonical, type, aliases, source=''){
    const div = document.createElement('div');
    div.className = 'mdc-card sku-card';
    div.dataset.canonical = canonical;
    const opts = aliases.map(a => `<option value="${a}">${a}</option>`).join('');
    const tags = aliases.map(a => `<span class="tag is-info is-light" data-alias="${a}">${a}<button type="button" class="delete is-small ml-1">×</button></span>`).join('');
    const show = aliases.length ? '' : 'style="display:none"';
    const parent = aliases.length ?
      `<div class="select"><select class="parent-select"><option value="${canonical}" selected>${canonical}</option>${opts}</select></div>` :
      `<strong>${canonical}</strong>`;
    const label = aliases.length ? 'Parent SKU' : 'SKU';
    div.innerHTML = `
      <div class="card-content">
        <div class="field is-flex is-align-items-center mb-2">
          <label class="label mb-0 mr-1">${label}</label>
          ${parent}
        </div>
        <div class="columns is-vcentered sku-row">
          <div class="column is-narrow merge-col">
            <input id="merge_${nextIdx}" class="switch merge-check" type="checkbox" name="select_${nextIdx}" value="${canonical}">
            <label for="merge_${nextIdx}">Merge</label>
            <span class="target-wrap is-hidden">
              <input id="target_${nextIdx}" class="switch target-check" type="checkbox" data-value="${canonical}">
              <label for="target_${nextIdx}">Parent</label>
            </span>
          </div>
          <div class="column is-narrow">
            <div class="field is-flex is-align-items-center">
              <label class="label mb-0 mr-1">Type</label>
              <div class="select">
                <select class="type-select">
                  <option value="unmapped" ${type==='unmapped'?'selected':''}>Unmapped</option>
                  <option value="machine" ${type==='machine'?'selected':''}>Machine</option>
                  <option value="detergent_filter_kits" ${type==='detergent_filter_kits'?'selected':''}>Detergent & Filter Kits</option>
                  <option value="detergent" ${type==='detergent'?'selected':''}>Detergents</option>
                  <option value="filters" ${type==='filters'?'selected':''}>Filters</option>
                  <option value="parts" ${type==='parts'?'selected':''}>Parts</option>
                  <option value="service" ${type==='service'?'selected':''}>Service</option>
                  <option value="shopify" ${type==='shopify'?'selected':''}>Shopify</option>
                  <option value="shipping" ${type==='shipping'?'selected':''}>Shipping</option>
                </select>
              </div>
            </div>
          </div>
          <div class="column is-narrow">
            <div class="field is-flex is-align-items-center">
              <label class="label mb-0 mr-1">Source</label>
              <strong>${source}</strong>
            </div>
          </div>
        </div>
        <div class="field alias-field" ${show}>
          <label class="label">Aliases</label>
          <div class="alias-badges mb-1">${tags}</div>
        </div>
      </div>`;
    return div;
  }

  function addDisplayCard(sec, canonical, type, aliases, source=''){
    if (document.querySelector(`#${sec} .sku-card[data-canonical="${canonical}"]`)) return;
    const section = document.getElementById(sec);
    const card = createDisplayCard(canonical, type, aliases, source);
    if (isAllTabActive()) {
      section.appendChild(card);
    } else {
      section.prepend(card);
    }
    card.querySelectorAll('.alias-badges .delete').forEach(setupAliasDelete);
    card.querySelectorAll('.parent-select').forEach(setupParentSelect);
    card.querySelectorAll('.type-select').forEach(setupDisplayTypeSelect);
    initCard(card);
    nextIdx++;
    updateCount(sec);
    return card;
  }

  function moveToMapped(card, type){
    const canonical = card.dataset.canonical;
    const src = card.querySelector('.sku-row strong')?.textContent.trim() || '';
    const input = card.querySelector('.alias-input');
    const aliases = input ? input.value.split(',').map(a => a.trim()).filter(Boolean) : [];
    addDisplayCard('mapped', canonical, type, aliases, src);
    if (aliases.length > 0) addDisplayCard('merged', canonical, type, aliases, src);
    const selected = card.querySelector('.merge-check')?.checked;
    if (!selected) {
      card.remove();
      updateCount('unmapped');
    } else {
      const sel = card.querySelector('select[name^="type_"]');
      if (sel) sel.value = type;
    }
    updateCount('mapped');
    updateCount('merged');
    filterSearch();
  }

  function aliasDeleteHandler(e){
    e.stopPropagation();
    const btn = e.currentTarget;
    const tag = btn.parentElement;
    const alias = tag.dataset.alias;
    const card = btn.closest('.sku-card');
    const canonical = card ? card.dataset.canonical : '';
    if (tag) tag.remove();
    if (!alias || !canonical) return;
    const mapCard = document.querySelector(`#unmapped .sku-card[data-canonical="${canonical}"]`);
    if (mapCard) {
      const input = mapCard.querySelector('.alias-input');
      if (input) {
        let aliases = input.value.split(',').map(a => a.trim()).filter(Boolean);
        aliases = aliases.filter(a => a !== alias);
        input.value = aliases.join(', ');
        input.dispatchEvent(new Event('change'));
      }
      const typeSel = mapCard.querySelector('select[name^="type_"]');
      const typeVal = typeSel ? typeSel.value : 'unmapped';
      addMapCard(alias, typeVal);
    }
    const container = card ? card.querySelector('.alias-badges') : null;
    const field = container ? container.closest('.alias-field') : null;
    if (container && container.children.length === 0) {
      if (field) field.style.display = 'none';
      card.remove();
      const sec = btn.closest('#merged') ? 'merged' : 'mapped';
      updateCount(sec);
      filterSearch();
    } else {
      refreshParentSelect(card);
      if (container) {
        card.dataset.aliases = Array.from(container.querySelectorAll('.tag')).map(t => t.dataset.alias).join(', ');
      }
    }
  }

  function setupAliasDelete(btn){
    btn.addEventListener('click', aliasDeleteHandler);
  }

  document.querySelectorAll('#merged .alias-badges .delete, #mapped .alias-badges .delete').forEach(setupAliasDelete);

  function refreshParentSelect(card){
    const select = card.querySelector('.parent-select');
    if (!select) return;
    const canonical = card.dataset.canonical;
    const aliases = Array.from(card.querySelectorAll('.alias-badges .tag')).map(t => t.dataset.alias).filter(Boolean);
    select.innerHTML = '';
    [canonical, ...aliases].forEach(v => {
      const opt = document.createElement('option');
      opt.value = v;
      opt.textContent = v;
      if (v === canonical) opt.selected = true;
      select.appendChild(opt);
    });
  }

  function moveCardToTop(card){
    if (isAllTabActive()) return;
    const mappedSection = document.getElementById('mapped');
    const mergedSection = document.getElementById('merged');
    if (card.closest('#mapped')) {
      mappedSection.prepend(card);
    } else if (card.closest('#merged')) {
      mergedSection.prepend(card);
    }
  }

  function moveToUnmapped(card){
    const canonical = card.dataset.canonical;
    const aliases = Array.from(card.querySelectorAll('.alias-badges .tag')).map(t => t.dataset.alias).filter(Boolean);
    addMapCard(canonical, 'unmapped');
    const mapCard = document.querySelector(`#unmapped .sku-card[data-canonical="${canonical}"]`);
    if (mapCard) {
      const input = mapCard.querySelector('.alias-input');
      if (input) {
        input.value = aliases.join(', ');
        input.dispatchEvent(new Event('change'));
      }
    }
    document.querySelectorAll(`#mapped .sku-card[data-canonical="${canonical}"], #merged .sku-card[data-canonical="${canonical}"]`).forEach(el => el.remove());
    updateCount('mapped');
    updateCount('merged');
    updateCount('unmapped');
    filterSearch();
  }

  function changeParent(card, newParent){
    const oldParent = card.dataset.canonical;
    if (newParent === oldParent) return;

    const container = card.querySelector('.alias-badges');
    const field = container ? container.closest('.alias-field') : null;
    const selectedTag = card.querySelector(`.alias-badges [data-alias="${newParent}"]`);
    if (selectedTag) selectedTag.remove();
    if (container) {
      const newTag = document.createElement('span');
      newTag.className = 'tag is-info is-light';
      newTag.dataset.alias = oldParent;
      newTag.textContent = oldParent;
      const delBtn = document.createElement('button');
      delBtn.type = 'button';
      delBtn.className = 'delete is-small ml-1';
      delBtn.textContent = '×';
      newTag.appendChild(delBtn);
      container.prepend(newTag);
      setupAliasDelete(delBtn);
      if (field) field.style.display = '';
    }

    card.dataset.canonical = newParent;
    refreshParentSelect(card);

    document.querySelectorAll(`#mapped .sku-card[data-canonical="${oldParent}"], #merged .sku-card[data-canonical="${oldParent}"]`).forEach(other => {
      if (other === card) return;
      const cont = other.querySelector('.alias-badges');
      const fld = cont ? cont.closest('.alias-field') : null;
      const selTag = other.querySelector(`.alias-badges [data-alias="${newParent}"]`);
      if (selTag) selTag.remove();
      if (cont) {
        const tag = document.createElement('span');
        tag.className = 'tag is-info is-light';
        tag.dataset.alias = oldParent;
        tag.textContent = oldParent;
        const delBtn = document.createElement('button');
        delBtn.type = 'button';
        delBtn.className = 'delete is-small ml-1';
        delBtn.textContent = '×';
        tag.appendChild(delBtn);
        cont.prepend(tag);
        setupAliasDelete(delBtn);
        if (fld) fld.style.display = '';
      }
      other.dataset.canonical = newParent;
      refreshParentSelect(other);
      if (!isFiltering() && !isAllTabActive()) moveCardToTop(other);
    });

    const typeVal = card.querySelector('.sku-row strong')?.textContent.trim() || 'unmapped';
    const aliasList = Array.from(card.querySelectorAll('.alias-badges .tag')).map(t => t.dataset.alias).filter(Boolean);
    aliasList.unshift(oldParent);
    let mapCard = document.querySelector(`#unmapped .sku-card[data-canonical="${newParent}"]`);
    if (!mapCard) {
      addMapCard(newParent, typeVal);
      mapCard = document.querySelector(`#unmapped .sku-card[data-canonical="${newParent}"]`);
    }
    const input = mapCard.querySelector('.alias-input');
    if (input) {
      input.value = Array.from(new Set(aliasList)).join(', ');
      input.dispatchEvent(new Event('change'));
    }

    const oldMap = document.querySelector(`#unmapped .sku-card[data-canonical="${oldParent}"]`);
    if (oldMap) {
      const oldInput = oldMap.querySelector('.alias-input');
      if (oldInput) {
        let aliases = oldInput.value.split(',').map(a => a.trim()).filter(Boolean);
        aliases = aliases.filter(a => a !== newParent);
        oldInput.value = aliases.join(', ');
        oldInput.dispatchEvent(new Event('change'));
      }
    }

    fetch('/update-parent', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({alias: oldParent, parent: newParent})
    });

    if (!isFiltering() && !isAllTabActive()) moveCardToTop(card);
    filterSearch();
  }

  function changeType(card, newType){
    const canonical = card.dataset.canonical;
    document.querySelectorAll(`.sku-card[data-canonical="${canonical}"]`).forEach(c => {
      if (c === card) return;
      const sel1 = c.querySelector('select[name^="type_"]');
      if (sel1) sel1.value = newType;
      const sel2 = c.querySelector('.type-select');
      if (sel2) sel2.value = newType;
    });
    fetch('/update-type', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({canonical, type: newType})
    });
    if(newType === 'unmapped' && !card.closest('#unmapped')){
      moveToUnmapped(card);
    } else if(newType !== 'unmapped' && card.closest('#unmapped')){
      moveToMapped(card, newType);
    }
    filterSearch();
  }

  function setupParentSelect(select){
    const card = select.closest('.sku-card');
    refreshParentSelect(card);
    select.addEventListener('change', () => {
      changeParent(card, select.value);
    });
  }

  function setupDisplayTypeSelect(select){
    const card = select.closest('.sku-card');
    select.addEventListener('change', () => {
      changeType(card, select.value);
    });
  }

  document.querySelectorAll('#mapped .parent-select, #merged .parent-select').forEach(setupParentSelect);
  document.querySelectorAll('#mapped .type-select, #merged .type-select').forEach(setupDisplayTypeSelect);

  updateTargets();
  updateCount('all');
})();
</script>
{% endblock %}
