{% extends "layout.html" %}
{% block content %}
<div class="card">
  <div class="card-content">
  <h2 class="title is-4 mb-4">SKU Alias Mapping</h2>
  <div class="tabs is-boxed" id="mapTabs">
    <ul>
      <li class="is-active" data-target="map"><a>Mapping</a></li>
      <li data-target="sug"><a>Suggestions</a></li>
    </ul>
  </div>
  <div id="map" class="tab-pane">
      <input type="text" id="searchBox" class="input mb-4" placeholder="Search SKUs">
      <form method="POST">
        <div class="table-container">
        <table id="skuTable" class="table is-bordered is-fullwidth sku-table">
          <thead>
            <tr>
              <th>Merge</th>
              <th>Target</th>
              <th>Canonical SKU</th>
              <th>Aliases</th>
              <th>Type</th>
            </tr>
          </thead>
          <tbody>
            {% for entry in grouped %}
            <tr>
              <td class="has-text-centered">
                  <input class="merge-check" type="checkbox" name="select_{{ loop.index0 }}" value="{{ entry.canonical }}">
              </td>
              <td class="has-text-centered">
                  <input class="target-radio" type="radio" name="merge_target" value="{{ entry.canonical }}">
              </td>
              <td><input class="input" type="text" name="canonical_{{ loop.index0 }}" value="{{ entry.canonical }}"></td>
              <td class="alias-cell">
                <input type="hidden" class="alias-input" name="aliases_{{ loop.index0 }}" value="{{ entry.aliases }}">
                <div class="alias-badges mb-1"></div>
                <button type="button" class="button is-small is-light add-alias">Add</button>
              </td>
              <td>
                <div class="select">
                <select name="type_{{ loop.index0 }}">
                  <option value="machine" {% if entry.type == 'machine' %}selected{% endif %}>Machine</option>
                  <option value="detergent" {% if entry.type == 'detergent' %}selected{% endif %}>Detergent</option>
                  <option value="filters" {% if entry.type == 'filters' %}selected{% endif %}>Filters</option>
                  <option value="maintenance" {% if entry.type == 'maintenance' %}selected{% endif %}>Maintenance</option>
                </select>
                </div>
              </td>
            </tr>
            {% endfor %}
            <tr>
              <td></td>
              <td></td>
              <td><input class="input" type="text" name="canonical_new"></td>
              <td class="alias-cell">
                <input type="hidden" class="alias-input" name="aliases_new">
                <div class="alias-badges mb-1"></div>
                <button type="button" class="button is-small is-light add-alias">Add</button>
              </td>
              <td>
                <div class="select">
                <select name="type_new">
                  <option value="machine">Machine</option>
                  <option value="detergent">Detergent</option>
                  <option value="filters">Filters</option>
                  <option value="maintenance">Maintenance</option>
                </select>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
        </div>
        <button class="button is-light mr-2" type="submit" name="merge" value="1">Merge Selected</button>
        <button class="button is-primary" type="submit" name="save" value="1">Save Changes</button>
      </form>
    </div>
    <div id="sug" class="tab-pane is-hidden">
      {% if suggestions %}
      <form method="POST">
        <table class="table is-fullwidth is-narrow">
          <thead>
            <tr><th></th><th>Keep</th><th>Merge</th><th>Score</th></tr>
          </thead>
          <tbody>
          {% for s in suggestions %}
          <tr>
            <td class="has-text-centered">
                <input type="checkbox" name="suggest_{{ loop.index0 }}">
            </td>
            <td>{{ s[0] }}<input type="hidden" name="sug_target_{{ loop.index0 }}" value="{{ s[0] }}"></td>
            <td>{{ s[1] }}<input type="hidden" name="sug_merge_{{ loop.index0 }}" value="{{ s[1] }}"></td>
            <td>{{ (s[2]*100)|round(1) }}%</td>
          </tr>
          {% endfor %}
          </tbody>
        </table>
        <button class="button is-light" type="submit" name="merge_suggestions" value="1">Merge Selected</button>
      </form>
      {% else %}
      <p>No suggestions available.</p>
      {% endif %}
  </div>
</div>
</div>
</div>
<script>
  document.getElementById('searchBox').addEventListener('input', function() {
    var term = this.value.toLowerCase();
    document.querySelectorAll('#skuTable tbody tr').forEach(function(row) {
      var canonicalInput = row.querySelector('input[name^="canonical_"]');
      var aliasInput = row.querySelector('input[name^="aliases_"]');
      if (canonicalInput && !canonicalInput.name.endsWith('_new')) {
        var text = canonicalInput.value.toLowerCase();
        if (aliasInput) {
          text += ' ' + aliasInput.value.toLowerCase();
        }
        row.style.display = text.indexOf(term) !== -1 ? '' : 'none';
      }
    });
  });

  // show aliases as removable badges
  document.querySelectorAll('.alias-input').forEach(function(input) {
    var container = input.nextElementSibling;
    var addBtn = container.nextElementSibling;
    function render() {
      container.innerHTML = '';
      var aliases = input.value.split(',').map(function(a){ return a.trim(); }).filter(Boolean);
      aliases.forEach(function(a) {
        var tag = document.createElement('span');
        tag.className = 'tag is-info is-light mr-1';
        tag.textContent = a;
        var del = document.createElement('button');
        del.type = 'button';
        del.className = 'delete is-small ml-1';
        del.addEventListener('click', function(){
          aliases = aliases.filter(function(x){ return x !== a; });
          input.value = aliases.join(', ');
          render();
        });
        tag.appendChild(del);
        container.appendChild(tag);
      });
    }
    render();
    if (addBtn) {
      addBtn.addEventListener('click', function() {
        var val = prompt('Add alias');
        if (val) {
          var aliases = input.value ? input.value.split(',') : [];
          aliases.push(val.trim());
          input.value = aliases.join(', ');
          render();
        }
      });
    }
  });

  // simple tabs
  document.querySelectorAll('#mapTabs li').forEach(function(tab){
    tab.addEventListener('click', function(){
      document.querySelectorAll('#mapTabs li').forEach(function(t){
        t.classList.remove('is-active');
      });
      tab.classList.add('is-active');
      document.querySelectorAll('.tab-pane').forEach(function(p){
        p.classList.add('is-hidden');
      });
      var target = tab.getAttribute('data-target');
      document.getElementById(target).classList.remove('is-hidden');
    });
  });

  // default merge target to first selected
  document.querySelectorAll('.merge-check').forEach(function(cb) {
    cb.addEventListener('change', function() {
      var checked = document.querySelector('.merge-check:checked');
      var currentTarget = document.querySelector('.target-radio:checked');
      if (checked && !currentTarget) {
        var row = checked.closest('tr');
        if (row) {
          row.querySelector('.target-radio').checked = true;
        }
      }
    });
  });

  // allow clicking the entire cell to toggle checkbox/radio
  document.querySelectorAll('#skuTable tbody tr').forEach(function(row) {
    var cbCell = row.cells[0];
    var radioCell = row.cells[1];
    if (cbCell && cbCell.querySelector('input')) {
      cbCell.style.cursor = 'pointer';
      cbCell.addEventListener('click', function(e) {
        if (e.target.tagName !== 'INPUT') {
          var input = cbCell.querySelector('input');
          input.checked = !input.checked;
          input.dispatchEvent(new Event('change'));
        }
      });
    }
    if (radioCell && radioCell.querySelector('input')) {
      radioCell.style.cursor = 'pointer';
      radioCell.addEventListener('click', function(e) {
        if (e.target.tagName !== 'INPUT') {
          radioCell.querySelector('input').checked = true;
        }
      });
    }
  });
</script>
{% endblock %}
