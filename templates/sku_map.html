{% extends "layout.html" %}
{% block content %}
<div class="mdc-card page-card">
  <div class="card-content">
    <h2 class="title is-4 mb-4">SKU alias mapping</h2>
    <nav class="buttons tab-buttons mb-4" id="mapTabs">
      <button type="button" class="mdc-button mdc-button--raised is-active" data-target="map">Mapping ({{ grouped|length }})</button>
      <button type="button" class="mdc-button mdc-button--raised" data-target="unmapped">Unmapped ({{ unmapped|length }})</button>
      <button type="button" class="mdc-button mdc-button--raised" data-target="merged">Merged ({{ merged|length }})</button>
      <button type="button" class="mdc-button mdc-button--raised" data-target="sug">Suggestions ({{ suggestions|length }})</button>
    </nav>
    <section id="map" class="tab-pane">
      <input type="text" id="searchBox" class="input mb-4" placeholder="Search SKUs and aliases">
      <form method="POST">
        <input type="hidden" id="merge_target" name="merge_target" value="">
        {% for entry in grouped %}
        <div class="mdc-card sku-card" data-canonical="{{ entry.canonical }}">
          <div class="card-content">
            <div class="field is-flex is-align-items-center mb-2">
              <label class="label mb-0 mr-1">SKU</label>
              <strong>{{ entry.canonical }}</strong>
              <input type="hidden" name="canonical_{{ loop.index0 }}" value="{{ entry.canonical }}">
            </div>
            <div class="columns is-vcentered sku-row">
              <div class="column is-narrow merge-col">
                <input id="merge_{{ loop.index0 }}" class="switch merge-check" type="checkbox" name="select_{{ loop.index0 }}" value="{{ entry.canonical }}">
                <label for="merge_{{ loop.index0 }}">Merge</label>
                <span class="target-wrap is-hidden">
                  <input id="target_{{ loop.index0 }}" class="switch target-check" type="checkbox" data-value="{{ entry.canonical }}">
                  <label for="target_{{ loop.index0 }}">Parent</label>
                </span>
              </div>
              <div class="column is-narrow">
                <div class="field is-flex is-align-items-center">
                  <label class="label mb-0 mr-1">Type</label>
                  <div class="select">
                    <select name="type_{{ loop.index0 }}">
                      <option value="unmapped" {% if entry.type == 'unmapped' %}selected{% endif %}>Unmapped</option>
                      <option value="machine" {% if entry.type == 'machine' %}selected{% endif %}>Machine</option>
                      <option value="detergent_filter_kits" {% if entry.type == 'detergent_filter_kits' %}selected{% endif %}>Detergent & Filter Kits</option>
                      <option value="detergent" {% if entry.type == 'detergent' %}selected{% endif %}>Detergents</option>
                      <option value="filters" {% if entry.type == 'filters' %}selected{% endif %}>Filters</option>
                      <option value="parts" {% if entry.type == 'parts' %}selected{% endif %}>Parts</option>
                      <option value="service" {% if entry.type == 'service' %}selected{% endif %}>Service</option>
                      <option value="shopify" {% if entry.type == 'shopify' %}selected{% endif %}>Shopify</option>
                      <option value="shipping" {% if entry.type == 'shipping' %}selected{% endif %}>Shipping</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>
            <div class="field alias-field" {% if not entry.aliases %}style="display:none"{% endif %}>
              <label class="label">Aliases</label>
              <input type="hidden" class="alias-input" name="aliases_{{ loop.index0 }}" value="{{ entry.aliases }}">
              <div class="alias-badges mb-1"></div>
            </div>
          </div>
        </div>
        {% endfor %}
        <hr class="my-4">
        <div class="mdc-card sku-card">
          <div class="card-content">
            <div class="field is-flex is-align-items-center mb-2">
              <label class="label mb-0 mr-1">SKU</label>
              <input class="input" name="canonical_new" placeholder="New canonical SKU">
            </div>
            <div class="columns is-vcentered sku-row">
              <div class="column is-narrow">
                <div class="field is-flex is-align-items-center">
                  <label class="label mb-0 mr-1">Type</label>
                  <div class="select">
                    <select name="type_new">
                      <option value="unmapped">Unmapped</option>
                      <option value="machine">Machine</option>
                      <option value="detergent_filter_kits">Detergent & Filter Kits</option>
                      <option value="detergent">Detergents</option>
                      <option value="filters">Filters</option>
                      <option value="parts">Parts</option>
                      <option value="service">Service</option>
                      <option value="shopify">Shopify</option>
                      <option value="shipping">Shipping</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>
            <div class="field alias-field" style="display:none">
              <label class="label">Aliases</label>
              <input type="text" class="input alias-input" name="aliases_new">
              <div class="alias-badges mb-1"></div>
            </div>
          </div>
        </div>
        <div class="buttons mb-5 mt-4">
          <button class="mdc-button mdc-button--raised" type="submit" name="merge" value="1">Merge selected</button>
          <button class="mdc-button mdc-button--raised" type="submit" name="save" value="1">Save changes</button>
        </div>
      </form>
    </section>
    <section id="unmapped" class="tab-pane is-hidden">
      {% for entry in unmapped %}
      <div class="mdc-card sku-card" data-canonical="{{ entry.canonical }}">
        <div class="card-content">
          <div class="columns is-vcentered sku-row">
            <div class="column">
              <div class="field is-flex is-align-items-center">
                <label class="label mb-0 mr-1">SKU</label>
                <strong>{{ entry.canonical }}</strong>
              </div>
            </div>
            <div class="column is-narrow">
              <div class="field is-flex is-align-items-center">
                <label class="label mb-0 mr-1">Type</label>
                <span>{{ entry.type }}</span>
              </div>
            </div>
          </div>
          <div class="field alias-field" {% if not entry.aliases %}style="display:none"{% endif %}>
            <label class="label">Aliases</label>
            <div class="alias-badges mb-1">
              {% for a in entry.aliases.split(',') if a.strip() %}
              <span class="tag is-info is-light">{{ a.strip() }}</span>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    </section>
    <section id="merged" class="tab-pane is-hidden">
      {% for entry in merged %}
      <div class="mdc-card sku-card" data-canonical="{{ entry.canonical }}">
        <div class="card-content">
          <div class="columns is-vcentered sku-row">
            <div class="column">
              <div class="field is-flex is-align-items-center">
                <label class="label mb-0 mr-1">SKU</label>
                <strong>{{ entry.canonical }}</strong>
              </div>
            </div>
            <div class="column is-narrow">
              <div class="field is-flex is-align-items-center">
                <label class="label mb-0 mr-1">Type</label>
                <span>{{ entry.type }}</span>
              </div>
            </div>
          </div>
          <div class="field alias-field" {% if not entry.aliases %}style="display:none"{% endif %}>
            <label class="label">Aliases</label>
            <div class="alias-badges mb-1">
              {% for a in entry.aliases.split(',') if a.strip() %}
              <span class="tag is-info is-light" data-alias="{{ a.strip() }}">
                {{ a.strip() }}
                <button type="button" class="delete is-small ml-1">Ã—</button>
              </span>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    </section>
    <section id="sug" class="tab-pane is-hidden">
      {% if suggestions %}
      <form method="POST">
        <div class="table-responsive">
        <table class="table is-fullwidth is-narrow">
          <thead>
            <tr><th></th><th>Keep</th><th>Merge</th><th class="no-wrap">Score</th></tr>
          </thead>
          <tbody>
          {% for s in suggestions %}
          <tr>
            <td class="has-text-centered">
              <input type="checkbox" name="suggest_{{ loop.index0 }}">
            </td>
            <td>{{ s[0] }}<input type="hidden" name="sug_target_{{ loop.index0 }}" value="{{ s[0] }}"></td>
            <td>{{ s[1] }}<input type="hidden" name="sug_merge_{{ loop.index0 }}" value="{{ s[1] }}"></td>
            <td class="no-wrap">{{ (s[2]*100)|round(1) }}%</td>
          </tr>
          {% endfor %}
          </tbody>
        </table>
        </div>
        <button class="mdc-button mdc-button--raised" type="submit" name="merge_suggestions" value="1">Merge selected</button>
      </form>
      {% else %}
      <p>No suggestions available.</p>
      {% endif %}
    </section>
  </div>
</div>
<script>
(function(){
  const active = document.querySelector('#mapTabs .is-active');
  if (active) {
    document.querySelectorAll('.tab-pane').forEach(p => p.classList.add('is-hidden'));
    document.getElementById(active.dataset.target).classList.remove('is-hidden');
  }
  document.querySelectorAll('#mapTabs button').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('#mapTabs button').forEach(b => b.classList.remove('is-active'));
      btn.classList.add('is-active');
      document.querySelectorAll('.tab-pane').forEach(p => p.classList.add('is-hidden'));
      document.getElementById(btn.dataset.target).classList.remove('is-hidden');
    });
  });

  const search = document.getElementById('searchBox');
  if (search) {
    search.addEventListener('input', () => {
      const term = search.value.toLowerCase();
      document.querySelectorAll('#map .sku-card').forEach(card => {
        const can = card.querySelector('input[name^="canonical_"]');
        const alias = card.querySelector('input[name^="aliases_"]');
        if (can && !can.name.endsWith('_new')) {
          let text = can.value.toLowerCase();
          if (alias) text += ' ' + alias.value.toLowerCase();
          card.style.display = text.includes(term) ? '' : 'none';
        }
      });
    });
  }

  function updateTargets(){
    const any = document.querySelector('.merge-check:checked');
    const current = document.querySelector('.target-check:checked');
    document.querySelectorAll('.sku-card').forEach(card => {
      const merge = card.querySelector('.merge-check');
      const wrap = card.querySelector('.target-wrap');
      const t = card.querySelector('.target-check');
      if (merge && wrap && t) {
        const show = any && merge.checked && (!current || t.checked);
        wrap.classList.toggle('is-hidden', !show);
      }
    });
    const hidden = document.getElementById('merge_target');
    if (hidden) hidden.value = current ? current.dataset.value : '';
  }

  function initAliasInput(input){
    const container = input.nextElementSibling;
    const field = input.closest('.alias-field');
    function render(){
      container.innerHTML = '';
      let aliases = Array.from(new Set(input.value.split(',').map(a => a.trim()).filter(Boolean)));
      aliases.forEach(a => {
        const tag = document.createElement('span');
        tag.className = 'tag is-info is-light';
        tag.dataset.alias = a;
        tag.textContent = a;
        const del = document.createElement('button');
        del.type = 'button';
        del.className = 'delete is-small ml-1';
        del.textContent = 'Ã—';
        del.addEventListener('click', e => {
          e.stopPropagation();
          aliases = aliases.filter(x => x !== a);
          input.value = aliases.join(', ');
          render();
        });
        tag.appendChild(del);
        container.appendChild(tag);
      });
      if (field) field.style.display = aliases.length ? '' : 'none';
    }
    input.addEventListener('blur', render);
    input.addEventListener('change', render);
    render();
  }

  function initCard(card){
    const cb = card.querySelector('.merge-check');
    if (cb) {
      card.classList.toggle('selected', cb.checked);
      cb.addEventListener('change', () => {
        card.classList.toggle('selected', cb.checked);
        if (!cb.checked) {
          const t = card.querySelector('.target-check');
          if (t && t.checked) t.checked = false;
        }
        if (!document.querySelector('.target-check:checked')) {
          const first = document.querySelector('.merge-check:checked');
          if (first) {
            const check = first.closest('.sku-card').querySelector('.target-check');
            if (check) check.checked = true;
          }
        }
        updateTargets();
      });
    }
    card.querySelectorAll('.target-check').forEach(tc => {
      tc.addEventListener('change', () => {
        if (tc.checked) {
          document.querySelectorAll('.target-check').forEach(o => { if (o !== tc) o.checked = false; });
        }
        updateTargets();
      });
    });
    card.querySelectorAll('.alias-input').forEach(initAliasInput);
    card.addEventListener('click', e => {
      if (e.target.closest('input') || e.target.closest('button') || e.target.closest('select')) return;
      if (cb) { cb.checked = !cb.checked; cb.dispatchEvent(new Event('change')); }
    });
  }

  document.querySelectorAll('.sku-card').forEach(initCard);

  let nextIdx = Math.max(0, ...Array.from(document.querySelectorAll('input[name^="canonical_"]')).map(i => parseInt(i.name.split('_')[1])||0)) + 1;

  const typeOptions = Array.from(document.querySelector('#map select[name^="type_"]').options).map(o => `<option value="${o.value}">${o.textContent}</option>`).join('');

  function createMapCard(idx, canonical, type){
    const div = document.createElement('div');
    div.className = 'mdc-card sku-card';
    div.dataset.canonical = canonical;
    div.innerHTML = `
      <div class="card-content">
        <div class="field is-flex is-align-items-center mb-2">
          <label class="label mb-0 mr-1">SKU</label>
          <strong>${canonical}</strong>
          <input type="hidden" name="canonical_${idx}" value="${canonical}">
        </div>
        <div class="columns is-vcentered sku-row">
          <div class="column is-narrow merge-col">
            <input id="merge_${idx}" class="switch merge-check" type="checkbox" name="select_${idx}" value="${canonical}">
            <label for="merge_${idx}">Merge</label>
            <span class="target-wrap is-hidden">
              <input id="target_${idx}" class="switch target-check" type="checkbox" data-value="${canonical}">
              <label for="target_${idx}">Parent</label>
            </span>
          </div>
          <div class="column is-narrow">
            <div class="field is-flex is-align-items-center">
              <label class="label mb-0 mr-1">Type</label>
              <div class="select">
                <select name="type_${idx}">${typeOptions}</select>
              </div>
            </div>
          </div>
        </div>
        <div class="field alias-field" style="display:none">
          <label class="label">Aliases</label>
          <input type="hidden" class="alias-input" name="aliases_${idx}" value="">
          <div class="alias-badges mb-1"></div>
        </div>
      </div>`;
    div.querySelector(`select[name="type_${idx}"]`).value = type || 'unmapped';
    return div;
  }

  function addMapCard(canonical, type){
    if (document.querySelector(`#map .sku-card[data-canonical="${canonical}"]`)) return;
    const form = document.querySelector('#map form');
    const hr = form.querySelector('hr.my-4');
    const card = createMapCard(nextIdx++, canonical, type);
    form.insertBefore(card, hr);
    initCard(card);
    updateTargets();
  }

  document.querySelectorAll('#merged .alias-badges .delete').forEach(btn => {
    btn.addEventListener('click', e => {
      e.stopPropagation();
      const tag = btn.parentElement;
      const alias = tag.dataset.alias;
      const card = btn.closest('.sku-card');
      const canonical = card ? card.dataset.canonical : '';
      if (tag) tag.remove();
      if (!alias || !canonical) return;
      const mapCard = document.querySelector(`#map .sku-card[data-canonical="${canonical}"]`);
      if (mapCard) {
        const input = mapCard.querySelector('.alias-input');
        if (input) {
          let aliases = input.value.split(',').map(a => a.trim()).filter(Boolean);
          aliases = aliases.filter(a => a !== alias);
          input.value = aliases.join(', ');
          input.dispatchEvent(new Event('change'));
        }
        const typeSel = mapCard.querySelector('select[name^="type_"]');
        const typeVal = typeSel ? typeSel.value : 'unmapped';
        addMapCard(alias, typeVal);
      }
      const container = card ? card.querySelector('.alias-badges') : null;
      const field = container ? container.closest('.alias-field') : null;
      if (container && container.children.length === 0) {
        if (field) field.style.display = 'none';
        card.remove();
        const mergedBtn = document.querySelector('#mapTabs button[data-target="merged"]');
        if (mergedBtn) {
          const count = document.querySelectorAll('#merged .sku-card').length;
          mergedBtn.textContent = `Merged (${count})`;
        }
      }
    });
  });

  updateTargets();
})();
</script>
{% endblock %}
