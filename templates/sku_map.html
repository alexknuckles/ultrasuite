{% extends "layout.html" %}
{% block content %}
<div class="card shadow-sm">
  <div class="card-body">
  <h2 class="card-title mb-4">SKU Alias Mapping</h2>
  <ul class="nav nav-tabs" id="mapTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="map-tab" data-bs-toggle="tab" data-bs-target="#map" type="button" role="tab">Mapping</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="sug-tab" data-bs-toggle="tab" data-bs-target="#sug" type="button" role="tab">Suggestions</button>
    </li>
  </ul>
  <div class="tab-content mt-3" id="mapTabsContent">
    <div class="tab-pane fade show active" id="map" role="tabpanel">
      <input type="text" id="searchBox" class="form-control mb-3" placeholder="Search SKUs">
      <form method="POST">
        <div class="table-responsive">
        <table id="skuTable" class="table table-bordered align-middle sku-table">
          <thead>
            <tr>
              <th>Merge</th>
              <th>Target</th>
              <th>Canonical SKU</th>
              <th>Aliases</th>
              <th>Type</th>
            </tr>
          </thead>
          <tbody>
            {% for entry in grouped %}
            <tr>
              <td class="text-center">
                <div class="form-check form-switch d-inline-block">
                  <input class="form-check-input merge-check" type="checkbox" name="select_{{ loop.index0 }}" value="{{ entry.canonical }}">
                </div>
              </td>
              <td class="text-center">
                <div class="form-check d-inline-block">
                  <input class="form-check-input target-radio" type="radio" name="merge_target" value="{{ entry.canonical }}">
                </div>
              </td>
              <td><input class="form-control" type="text" name="canonical_{{ loop.index0 }}" value="{{ entry.canonical }}"></td>
              <td class="alias-cell">
                <input class="form-control alias-input" type="text" name="aliases_{{ loop.index0 }}" value="{{ entry.aliases }}">
                <div class="alias-badges mt-1"></div>
              </td>
              <td>
                <select class="form-control" name="type_{{ loop.index0 }}">
                  <option value="machine" {% if entry.type == 'machine' %}selected{% endif %}>Machine</option>
                  <option value="detergent" {% if entry.type == 'detergent' %}selected{% endif %}>Detergent</option>
                  <option value="filters" {% if entry.type == 'filters' %}selected{% endif %}>Filters</option>
                  <option value="maintenance" {% if entry.type == 'maintenance' %}selected{% endif %}>Maintenance</option>
                </select>
              </td>
            </tr>
            {% endfor %}
            <tr>
              <td></td>
              <td></td>
              <td><input class="form-control" type="text" name="canonical_new"></td>
              <td class="alias-cell">
                <input class="form-control alias-input" type="text" name="aliases_new">
                <div class="alias-badges mt-1"></div>
              </td>
              <td>
                <select class="form-control" name="type_new">
                  <option value="machine">Machine</option>
                  <option value="detergent">Detergent</option>
                  <option value="filters">Filters</option>
                  <option value="maintenance">Maintenance</option>
                </select>
              </td>
            </tr>
          </tbody>
        </table>
        </div>
        <button class="btn btn-secondary me-2" type="submit" name="merge" value="1">Merge Selected</button>
        <button class="btn btn-primary" type="submit" name="save" value="1">Save Changes</button>
      </form>
    </div>
    <div class="tab-pane fade" id="sug" role="tabpanel">
      {% if suggestions %}
      <form method="POST">
        <table class="table table-sm">
          <thead>
            <tr><th></th><th>Keep</th><th>Merge</th><th>Score</th></tr>
          </thead>
          <tbody>
          {% for s in suggestions %}
          <tr>
            <td class="text-center">
              <div class="form-check form-switch d-inline-block">
                <input class="form-check-input" type="checkbox" name="suggest_{{ loop.index0 }}">
              </div>
            </td>
            <td>{{ s[0] }}<input type="hidden" name="sug_target_{{ loop.index0 }}" value="{{ s[0] }}"></td>
            <td>{{ s[1] }}<input type="hidden" name="sug_merge_{{ loop.index0 }}" value="{{ s[1] }}"></td>
            <td>{{ (s[2]*100)|round(1) }}%</td>
          </tr>
          {% endfor %}
          </tbody>
        </table>
        <button class="btn btn-secondary" type="submit" name="merge_suggestions" value="1">Merge Selected</button>
      </form>
      {% else %}
      <p>No suggestions available.</p>
      {% endif %}
  </div>
</div>
</div>
</div>
<script>
  document.getElementById('searchBox').addEventListener('input', function() {
    var term = this.value.toLowerCase();
    document.querySelectorAll('#skuTable tbody tr').forEach(function(row) {
      var canonicalInput = row.querySelector('input[name^="canonical_"]');
      var aliasInput = row.querySelector('input[name^="aliases_"]');
      if (canonicalInput && !canonicalInput.name.endsWith('_new')) {
        var text = canonicalInput.value.toLowerCase();
        if (aliasInput) {
          text += ' ' + aliasInput.value.toLowerCase();
        }
        row.style.display = text.indexOf(term) !== -1 ? '' : 'none';
      }
    });
  });

  // show aliases as removable badges
  document.querySelectorAll('.alias-input').forEach(function(input) {
    var container = input.nextElementSibling;
    function render() {
      container.innerHTML = '';
      var aliases = input.value.split(',').map(function(a){ return a.trim(); }).filter(Boolean);
      aliases.forEach(function(a) {
        var badge = document.createElement('span');
        badge.className = 'badge bg-secondary me-1';
        badge.textContent = a + ' ';
        var btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'btn-close btn-close-white btn-sm';
        btn.addEventListener('click', function(){
          aliases = aliases.filter(function(x){ return x !== a; });
          input.value = aliases.join(', ');
          render();
        });
        badge.appendChild(btn);
        container.appendChild(badge);
      });
    }
    render();
  });

  // default merge target to first selected
  document.querySelectorAll('.merge-check').forEach(function(cb) {
    cb.addEventListener('change', function() {
      var checked = document.querySelector('.merge-check:checked');
      var currentTarget = document.querySelector('.target-radio:checked');
      if (checked && !currentTarget) {
        checked.parentElement.parentElement.querySelector('.target-radio').checked = true;
      }
    });
  });

  // allow clicking the entire cell to toggle checkbox/radio
  document.querySelectorAll('#skuTable tbody tr').forEach(function(row) {
    var cbCell = row.cells[0];
    var radioCell = row.cells[1];
    if (cbCell && cbCell.querySelector('input')) {
      cbCell.style.cursor = 'pointer';
      cbCell.addEventListener('click', function(e) {
        if (e.target.tagName !== 'INPUT') {
          var input = cbCell.querySelector('input');
          input.checked = !input.checked;
          input.dispatchEvent(new Event('change'));
        }
      });
    }
    if (radioCell && radioCell.querySelector('input')) {
      radioCell.style.cursor = 'pointer';
      radioCell.addEventListener('click', function(e) {
        if (e.target.tagName !== 'INPUT') {
          radioCell.querySelector('input').checked = true;
        }
      });
    }
  });
</script>
{% endblock %}
