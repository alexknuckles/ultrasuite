{% extends "layout.html" %}
{% block content %}
<div class="card">
  <div class="card-content">
    <h2 class="title is-4 mb-4">SKU Alias Mapping</h2>
    <div class="tabs is-boxed" id="mapTabs">
      <ul>
        <li class="is-active" data-target="map"><a>Mapping</a></li>
        <li data-target="sug"><a>Suggestions</a></li>
      </ul>
    </div>
    <div id="map" class="tab-pane">
      <input type="text" id="searchBox" class="input mb-4" placeholder="Search SKUs">
      <form method="POST">
        {% for entry in grouped %}
        <div class="card sku-card">
          <div class="card-content">
            <div class="columns is-variable is-1">
              <div class="column is-narrow merge-col">
                <input id="merge_{{ loop.index0 }}" class="switch is-rounded is-info merge-check" type="checkbox" name="select_{{ loop.index0 }}" value="{{ entry.canonical }}">
                <label for="merge_{{ loop.index0 }}" class="mr-2">Merge</label>
                <label class="radio target-wrap is-invisible">
                  <input class="target-radio" type="radio" name="merge_target" value="{{ entry.canonical }}">
                  Target
                </label>
              </div>
              <div class="column">
                <div class="field is-flex is-align-items-center">
                  <label class="label mb-0 mr-1">SKU</label>
                  <span>{{ entry.canonical }}</span>
                  <input type="hidden" name="canonical_{{ loop.index0 }}" value="{{ entry.canonical }}">
                </div>
                <div class="field alias-field" {% if not entry.aliases %}style="display:none"{% endif %}>
                  <label class="label">Aliases</label>
                  <input type="hidden" class="alias-input" name="aliases_{{ loop.index0 }}" value="{{ entry.aliases }}">
                  <div class="alias-badges mb-1"></div>
                </div>
              </div>
              <div class="column is-narrow">
                <div class="field is-flex is-align-items-center">
                  <label class="label mb-0 mr-1">Type</label>
                  <div class="select">
                    <select name="type_{{ loop.index0 }}">
                      <option value="machine" {% if entry.type == 'machine' %}selected{% endif %}>Machine</option>
                      <option value="detergent" {% if entry.type == 'detergent' %}selected{% endif %}>Detergent</option>
                      <option value="filters" {% if entry.type == 'filters' %}selected{% endif %}>Filters</option>
                      <option value="maintenance" {% if entry.type == 'maintenance' %}selected{% endif %}>Maintenance</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
        <div class="card sku-card">
          <div class="card-content">
            <div class="columns is-variable is-1">
              <div class="column is-narrow merge-col"></div>
              <div class="column">
                <div class="field">
                  <label class="label">SKU</label>
                  <input class="input" type="text" name="canonical_new">
                </div>
                <div class="field alias-field">
                  <label class="label">Aliases</label>
                  <input type="hidden" class="alias-input" name="aliases_new">
                  <div class="alias-badges mb-1"></div>
                </div>
              </div>
              <div class="column is-narrow">
                <div class="field is-flex is-align-items-center">
                  <label class="label mb-0 mr-1">Type</label>
                  <div class="select">
                    <select name="type_new">
                      <option value="machine">Machine</option>
                      <option value="detergent">Detergent</option>
                      <option value="filters">Filters</option>
                      <option value="maintenance">Maintenance</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="buttons mb-5">
          <button class="button is-light" type="submit" name="merge" value="1">Merge Selected</button>
          <button class="button is-primary" type="submit" name="save" value="1">Save Changes</button>
        </div>
      </form>
    </div>
    <div id="sug" class="tab-pane is-hidden">
      {% if suggestions %}
      <form method="POST">
        <table class="table is-fullwidth is-narrow">
          <thead>
            <tr><th></th><th>Keep</th><th>Merge</th><th>Score</th></tr>
          </thead>
          <tbody>
          {% for s in suggestions %}
          <tr>
            <td class="has-text-centered">
                <input type="checkbox" name="suggest_{{ loop.index0 }}">
            </td>
            <td>{{ s[0] }}<input type="hidden" name="sug_target_{{ loop.index0 }}" value="{{ s[0] }}"></td>
            <td>{{ s[1] }}<input type="hidden" name="sug_merge_{{ loop.index0 }}" value="{{ s[1] }}"></td>
            <td>{{ (s[2]*100)|round(1) }}%</td>
          </tr>
          {% endfor %}
          </tbody>
        </table>
        <button class="button is-light" type="submit" name="merge_suggestions" value="1">Merge Selected</button>
      </form>
      {% else %}
      <p>No suggestions available.</p>
      {% endif %}
    </div>
  </div>
</div>
<script>
  document.getElementById('searchBox').addEventListener('input', function() {
    var term = this.value.toLowerCase();
    document.querySelectorAll('.sku-card').forEach(function(card) {
      var canonicalInput = card.querySelector('input[name^="canonical_"]');
      var aliasInput = card.querySelector('input[name^="aliases_"]');
      if (canonicalInput && !canonicalInput.name.endsWith('_new')) {
        var text = canonicalInput.value.toLowerCase();
        if (aliasInput) {
          text += ' ' + aliasInput.value.toLowerCase();
        }
        card.style.display = text.indexOf(term) !== -1 ? '' : 'none';
      }
    });
  });

  document.querySelectorAll('#mapTabs li').forEach(function(tab){
    tab.addEventListener('click', function(){
      document.querySelectorAll('#mapTabs li').forEach(function(t){
        t.classList.remove('is-active');
      });
      tab.classList.add('is-active');
      document.querySelectorAll('.tab-pane').forEach(function(p){
        p.classList.add('is-hidden');
      });
      var target = tab.getAttribute('data-target');
      document.getElementById(target).classList.remove('is-hidden');
    });
  });

  function updateTargets() {
    document.querySelectorAll('.sku-card').forEach(function(card){
      var cb = card.querySelector('.merge-check');
      var wrap = card.querySelector('.target-wrap');
      if (cb && wrap) {
        wrap.classList.toggle('is-invisible', !cb.checked);
      }
    });
  }

  document.querySelectorAll('.merge-check').forEach(function(cb) {
    cb.addEventListener('change', function() {
      var card = cb.closest('.sku-card');
      if (card) {
        card.classList.toggle('selected', cb.checked);
        if (!cb.checked) {
          var radio = card.querySelector('.target-radio');
          if (radio && radio.checked) {
            radio.checked = false;
          }
        }
      }
      var currentTarget = document.querySelector('.target-radio:checked');
      if (!currentTarget) {
        var first = document.querySelector('.merge-check:checked');
        if (first) {
          var radio = first.closest('.sku-card').querySelector('.target-radio');
          if (radio) {
            radio.checked = true;
          }
        }
      }
      updateTargets();
    });
    var card = cb.closest('.sku-card');
    if (card) {
      card.classList.toggle('selected', cb.checked);
    }
  });
  updateTargets();

  document.querySelectorAll('.alias-input').forEach(function(input) {
    var container = input.nextElementSibling;
    var field = input.closest('.alias-field');
    function render() {
      container.innerHTML = '';
      var aliases = input.value.split(',').map(function(a){ return a.trim(); }).filter(Boolean);
      aliases.forEach(function(a) {
        var tag = document.createElement('span');
        tag.className = 'tag is-info is-light';
        tag.textContent = a;
        var del = document.createElement('button');
        del.type = 'button';
        del.className = 'delete is-small ml-1';
        del.addEventListener('click', function(e){
          e.stopPropagation();
          aliases = aliases.filter(function(x){ return x !== a; });
          input.value = aliases.join(', ');
          render();
        });
        tag.appendChild(del);
        container.appendChild(tag);
      });
      if (field) {
        field.style.display = aliases.length ? '' : 'none';
      }
    }
    render();
  });

  document.querySelectorAll('.sku-card').forEach(function(card) {
    card.addEventListener('click', function(e){
      if (e.target.closest('input') || e.target.closest('button') || e.target.closest('select')) {
        return;
      }
      var cb = card.querySelector('.merge-check');
      cb.checked = !cb.checked;
      cb.dispatchEvent(new Event('change'));
    });
  });
</script>
{% endblock %}
