{% extends "layout.html" %}
{% block content %}
<div class="card">
  <div class="card-content report-content">
    <h2 class="title is-4">Reports</h2>
    <form method="get" class="mb-4">
      <label class="label">Select Year:</label>
      <div class="select is-inline-block">
        <select name="year" onchange="this.form.submit()">
        {% for y in years %}
        <option value="{{ y }}" {% if y == selected_year %}selected{% endif %}>{{ y }}</option>
        {% endfor %}
        </select>
      </div>
    </form>
    <div class="tabs is-boxed" id="reportTabs">
      <ul>
        <li class="is-active" data-target="by-month"><a>By Month</a></li>
        <li data-target="by-year"><a>By Year</a></li>
      </ul>
    </div>

    <div id="by-month" class="tab-pane">
      <h4 class="title is-5">Last Month Sales by Type ({{ last_month_label }})</h4>
      <img id="lastMonthChart" data-src="{{ url_for('last_month_chart', year=selected_year) }}" class="my-3" alt="Last Month Chart">

      <h4 class="title is-5 mt-5">Last Full Month by Type ({{ last_month_label }})</h4>
      <table class="table is-fullwidth is-striped is-narrow">
        <thead>
          <tr>
            <th>Type</th>
            <th>{{ last_month_label }} $</th>
            <th>vs Last Year</th>
            <th>Avg Month $</th>
            <th>Best Month $</th>
          </tr>
        </thead>
        <tbody>
          {% for r in last_rows %}
          <tr{% if r.type == 'Total' %} class="has-background-light has-text-weight-bold"{% endif %}>
            <td>{{ r.type }}</td>
            <td>${{ "%.2f"|format(r.total) }}</td>
            <td>{{ r.vs_last | trend }}</td>
            <td>{{ ("$%.2f"|format(r.avg_month)) | trend(r.avg_month_sign) }}</td>
            <td>{{ ("$%.2f"|format(r.best_month)) | trend(r.best_month_sign) }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>


      {% for cat, rows in sku_details.items() %}
      <h4 class="title is-5 mt-5">{{ labels[cat] }} Details ({{ last_month_label }})</h4>
      <table class="table is-fullwidth is-striped is-narrow">
        <thead>
          <tr>
            <th>SKU</th>
            <th>Yearly $</th>
            <th>Yearly Qty</th>
            <th>{{ last_month_label }} $</th>
            <th>{{ last_month_label }} Qty</th>
            <th>Avg Month $</th>
            <th>Avg Qty</th>
            <th>Last Year $</th>
            <th>Best Month $</th>
            <th>Best Qty</th>
          </tr>
        </thead>
        <tbody>
          {% for r in rows %}
          <tr>
            <td>{{ r.sku }}</td>
            <td>${{ "%.2f"|format(r.year_total) }}</td>
            <td>{{ "%.2f"|format(r.year_qty) }}</td>
            <td>${{ "%.2f"|format(r.month_total) }}</td>
            <td>{{ "%.2f"|format(r.month_qty) }}</td>
            <td>{{ ("$%.2f"|format(r.avg_month)) | trend(r.avg_month_sign) }}</td>
            <td>{{ ("%.2f"|format(r.avg_qty)) | trend(r.avg_qty_sign) }}</td>
            <td>{{ ("$%.2f"|format(r.last_year)) | trend(r.last_year_sign) }}</td>
            <td>{{ ("$%.2f"|format(r.best_month)) | trend(r.best_month_sign) }}</td>
            <td>{{ ("%.2f"|format(r.best_qty)) | trend(r.best_qty_sign) }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% endfor %}
    </div> <!-- by-month -->

    <div id="by-year" class="tab-pane is-hidden">
      <h4 class="title is-5">Overall Sales by Month ({{ selected_year }})</h4>
      <img id="yearChart" data-src="{{ url_for('report_chart', year=selected_year) }}" class="my-3" alt="Monthly Chart">
      <table class="table is-fullwidth is-bordered mb-5">
        <thead>
          <tr><th>Month</th><th>{{ selected_year }} $</th><th>{{ selected_year - 1 }} $</th><th>% Change</th></tr>
        </thead>
        <tbody>
          {% for month, current, previous, pct in rows %}
          <tr>
            <td>{{ month }}</td>
            <td>${{ "%.2f"|format(current or 0) }}</td>
            <td>${{ "%.2f"|format(previous or 0) }}</td>
            <td>{{ pct | trend }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>

      <h4 class="title is-5">Yearly Summary by Type</h4>
      <table class="table is-fullwidth is-striped is-narrow">
        <thead>
          <tr>
            <th>Type</th>
            <th>Total $</th>
            <th>vs Last Year</th>
            <th>Avg Month $</th>
            <th>Best Month $</th>
            <th>Avg Qty</th>
            <th>Best Qty</th>
          </tr>
        </thead>
        <tbody>
          {% for r in type_rows %}
          <tr>
            <td>{{ r.type }}</td>
            <td>${{ "%.2f"|format(r.total) }}</td>
            <td>{{ r.vs_last | trend }}</td>
            <td>{{ ("$%.2f"|format(r.avg_month)) | trend }}</td>
            <td>{{ ("$%.2f"|format(r.best_month)) | trend }}</td>
            <td>{{ ("%.2f"|format(r.avg_qty)) | trend }}</td>
            <td>{{ ("%.2f"|format(r.best_qty)) | trend }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>

    </div> <!-- by-year -->

    <div class="has-text-right mt-4">
      <button onclick="window.print()" class="button is-light">üñ®Ô∏è Print Report</button>
    </div>
  </div>
</div>
<script>
  document.querySelectorAll('#reportTabs li').forEach(function(tab){
    tab.addEventListener('click', function(){
      document.querySelectorAll('#reportTabs li').forEach(function(t){ t.classList.remove('is-active'); });
      tab.classList.add('is-active');
      document.querySelectorAll('.tab-pane').forEach(function(p){ p.classList.add('is-hidden'); });
      var target = tab.getAttribute('data-target');
      document.getElementById(target).classList.remove('is-hidden');
      if(target === 'by-year') {
        var img = document.getElementById('yearChart');
        if(img && !img.src){
          img.src = img.getAttribute('data-src') + '&t=' + Date.now();
        }
      } else if(target === 'by-month') {
        var img2 = document.getElementById('lastMonthChart');
        if(img2 && !img2.src){
          img2.src = img2.getAttribute('data-src') + '&t=' + Date.now();
        }
      }
    });
  });
  document.addEventListener('DOMContentLoaded', function(){
    var monthImg = document.getElementById('lastMonthChart');
    if(monthImg){
      monthImg.src = monthImg.getAttribute('data-src') + '&t=' + Date.now();
    }
  });
</script>
{% endblock %}
