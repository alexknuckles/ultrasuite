{% extends "layout.html" %}
{% block content %}
<div class="mdc-card page-card">
  <div class="card-content">
    <h2 class="title is-4 mb-4">Transactions</h2>
    <form method="get" class="mb-4 filter-form">
      <div class="field mr-2">
        <label class="label">SKU</label>
        <div class="select">
          <select name="sku" onchange="this.form.submit()">
            <option value="">All mapped</option>
            {% for opt in sku_options %}
            <option value="{{ opt }}" {% if opt == sku %}selected{% endif %}>{{ opt }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
      <div class="field mr-2">
        <label class="label">Upload</label>
        <div class="select">
          <select name="source" onchange="this.form.submit()">
            <option value="both" {% if source == 'both' %}selected{% endif %}>Both</option>
            <option value="shopify" {% if source == 'shopify' %}selected{% endif %}>Shopify</option>
            <option value="qbo" {% if source == 'qbo' %}selected{% endif %}>QBO</option>
          </select>
        </div>
      </div>
      <div class="field mr-2">
        <button id="datePickerBtn" type="button" class="mdc-button">
          <span>ðŸ“…</span>
          <span id="dateLabel">All</span>
        </button>
        <input type="hidden" name="period" id="periodInput" value="{{ period }}">
        <input type="hidden" name="start" id="startInput" value="{{ start or '' }}">
        <input type="hidden" name="end" id="endInput" value="{{ end or '' }}">
      </div>
    </form>
    <div id="dateModal" class="date-modal is-hidden">
      <div class="date-modal-content">
        <div class="date-modal-left">
          <ul id="dateTabs">
            <li data-type="" class="is-active">All</li>
            <li data-type="last30">Last 30 days</li>
            <li data-type="day">Day</li>
            <li data-type="month">Month</li>
            <li data-type="year">Year</li>
            <li data-type="range">Range</li>
          </ul>
        </div>
        <div class="date-modal-right">
          <div id="pane-all" class="date-pane"></div>
          <div id="pane-last30" class="date-pane is-hidden"></div>
          <div id="pane-day" class="date-pane is-hidden">
            <input type="date" id="dayInput" class="input">
          </div>
          <div id="pane-month" class="date-pane is-hidden">
            <div class="is-flex is-align-items-center">
              <div class="select mr-2">
                <select id="monthSelect">
                  <option value="">Month</option>
                  <option value="01">Jan</option>
                  <option value="02">Feb</option>
                  <option value="03">Mar</option>
                  <option value="04">Apr</option>
                  <option value="05">May</option>
                  <option value="06">Jun</option>
                  <option value="07">Jul</option>
                  <option value="08">Aug</option>
                  <option value="09">Sep</option>
                  <option value="10">Oct</option>
                  <option value="11">Nov</option>
                  <option value="12">Dec</option>
                </select>
              </div>
              <div class="select">
                <select id="monthYearSelect">
                  {% for y in years %}
                  <option value="{{ y }}">{{ y }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>
          </div>
          <div id="pane-year" class="date-pane is-hidden">
            <div class="select">
              <select id="yearSelect2">
                {% for y in years %}
                <option value="{{ y }}">{{ y }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
          <div id="pane-range" class="date-pane is-hidden">
            <div class="is-flex is-align-items-end">
              <div class="field mr-2">
                <label class="label">Start</label>
                <input type="date" id="startInput2" class="input">
              </div>
              <div class="field">
                <label class="label">End</label>
                <input type="date" id="endInput2" class="input">
              </div>
            </div>
          </div>
          <div class="buttons mt-2">
            <button id="applyDate" type="button" class="mdc-button mdc-button--raised">Apply</button>
            <button id="cancelDate" type="button" class="mdc-button">Cancel</button>
          </div>
        </div>
      </div>
    </div>
      {# Show summary for selected SKU or all SKUs #}
      <div class="table-responsive">
      <table class="table is-fullwidth is-striped is-narrow mb-4">
      <thead>
        <tr><th>Source</th><th>Quantity</th><th>Total $</th></tr>
      </thead>
      <tbody>
        {% if show_shopify %}
        <tr>
          <td>Shopify</td>
          <td>{{ "%.2f"|format(summary.shopify.quantity) }}</td>
          <td>${{ "%.2f"|format(summary.shopify.total) }}</td>
        </tr>
        {% endif %}
        {% if show_qbo %}
        <tr>
          <td>QBO</td>
          <td>{{ "%.2f"|format(summary.qbo.quantity) }}</td>
          <td>${{ "%.2f"|format(summary.qbo.total) }}</td>
        </tr>
        {% endif %}
      </tbody>
    </table>
    </div>
    <div class="table-responsive">
    <table class="table is-fullwidth is-striped is-narrow">
      <thead>
        <tr>
          <th class="no-wrap">Date</th><th class="no-wrap">SKU</th><th>Description</th><th class="no-wrap">Price $</th><th class="no-wrap">Quantity</th><th class="no-wrap">Total $</th><th class="no-wrap">Source</th>
        </tr>
      </thead>
      <tbody>
        {% for row in rows %}
        <tr>
          <td class="no-wrap">{{ row.created_at|format_dt }}</td>
          <td class="no-wrap">{{ row.sku }}</td>
          <td>{{ row.description }}</td>
          <td class="no-wrap">{{ "%.2f"|format(row.price) }}</td>
          <td class="no-wrap">{{ "%.2f"|format(row.quantity) }}</td>
          <td class="no-wrap">${{ "%.2f"|format(row.total) }}</td>
          <td class="no-wrap">{{ row.source_title }}</td>
        </tr>
        {% endfor %}
      </tbody>
      </table>
      </div>
  </div>
  </div>

{% if duplicates is defined %}
<div class="mdc-card page-card mt-5">
  <header class="card-header">
    <p class="card-header-title">Duplicate Transactions</p>
  </header>
  <div class="card-content">
    {% if duplicates %}
    <div class="table-responsive">
    <table class="table is-fullwidth is-striped is-narrow">
      <thead>
        <tr>
          <th>Date</th>
          <th>SKU</th>
          <th>Shopify Description</th>
          <th>QBO Description</th>
          <th>Qty</th>
          <th>Total</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        {% for d in duplicates %}
        <tr id="dup-{{ d.shopify_id }}-{{ d.qbo_id }}">
          <td>{{ d.created_at|format_dt }}</td>
          <td>{{ d.sku }}</td>
          <td>{{ d.shopify_desc }}</td>
          <td>{{ d.qbo_desc }}</td>
          <td>{{ d.quantity }}</td>
          <td>${{ "%.2f"|format(d.total) }}</td>
          <td>
            {% if d.unmatched %}
            <span class="tag is-warning is-light mr-2">Unmatched</span>
            {% endif %}
            <button data-action="shopify" data-sid="{{ d.shopify_id }}" data-qid="{{ d.qbo_id }}" class="mdc-button mdc-button--raised">Keep Shopify</button>
            <button data-action="qbo" data-sid="{{ d.shopify_id }}" data-qid="{{ d.qbo_id }}" class="mdc-button mdc-button--raised">Keep QBO</button>
            <button data-action="both" data-sid="{{ d.shopify_id }}" data-qid="{{ d.qbo_id }}" class="mdc-button mdc-button--raised">Keep Both</button>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    </div>
    {% else %}
    <p>No duplicates found.</p>
    {% endif %}
  </div>
  </div>
  {% endif %}

{% if resolved_duplicates %}
<div class="mdc-card page-card mt-5">
  <header class="card-header">
    <p class="card-header-title">Previously Resolved Duplicates</p>
  </header>
  <div class="card-content">
    <div class="table-responsive">
    <table class="table is-fullwidth is-striped is-narrow">
      <thead>
        <tr>
          <th>Resolved At</th>
          <th>Shopify Date</th>
          <th>QBO Date</th>
          <th>Action</th>
          <th>Parent SKU</th>
          <th>Shopify SKU</th>
          <th>QBO SKU</th>
          <th>Qty</th>
          <th>Total</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        {% for d in resolved_duplicates %}
        <tr>
          <td>{{ d.resolved_at|format_dt }}</td>
          <td>{{ d.shopify_created_at|format_dt }}</td>
          <td>{{ d.qbo_created_at|format_dt }}</td>
          <td>{{ d.action|capitalize }}</td>
          <td>{{ d.sku }}</td>
          <td>{{ d.shopify_sku }}</td>
          <td>{{ d.qbo_sku }}</td>
          <td>{{ d.quantity }}</td>
          <td>${{ "%.2f"|format(d.total) }}</td>
          <td>
            {% if d.ignored %}
            <span>Unmatched</span>
            {% else %}
            <button data-unmatch data-sid="{{ d.shopify_id }}" data-qid="{{ d.qbo_id }}" class="mdc-button">Unmatch</button>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    </div>
  </div>
</div>
{% endif %}

  <script>
  document.addEventListener('DOMContentLoaded', function(){
    var form = document.querySelector('form');
    var modal = document.getElementById('dateModal');
    var btn = document.getElementById('datePickerBtn');
    var dateLabel = document.getElementById('dateLabel');
    var tabs = document.querySelectorAll('#dateTabs li');
    var panes = document.querySelectorAll('.date-pane');
    var periodInput = document.getElementById('periodInput');
    var startInput = document.getElementById('startInput');
    var endInput = document.getElementById('endInput');
    var dayInput = document.getElementById('dayInput');
    var monthSelect = document.getElementById('monthSelect');
    var monthYearSelect = document.getElementById('monthYearSelect');
    var yearSelect = document.getElementById('yearSelect2');
    var startRange = document.getElementById('startInput2');
    var endRange = document.getElementById('endInput2');
    var apply = document.getElementById('applyDate');
    var cancel = document.getElementById('cancelDate');
    var activeType = '';

    var init = periodInput.value;
    if(init.startsWith('year-')){
      activeType = 'year';
      yearSelect.value = init.split('-')[1];
    } else if(init.startsWith('month-')){
      activeType = 'month';
      var p = init.split('-');
      monthYearSelect.value = p[1];
      monthSelect.value = p[2];
    } else if(init === 'last30'){
      activeType = 'last30';
    } else if(init === 'custom' && startInput.value && endInput.value){
      if(startInput.value === endInput.value){
        activeType = 'day';
        dayInput.value = startInput.value;
      } else {
        activeType = 'range';
        startRange.value = startInput.value;
        endRange.value = endInput.value;
      }
    } else if(startInput.value && endInput.value){
      if(startInput.value === endInput.value){
        activeType = 'day';
        dayInput.value = startInput.value;
      } else {
        activeType = 'range';
        startRange.value = startInput.value;
        endRange.value = endInput.value;
      }
    }

    tabs.forEach(function(x){
      x.classList.remove('is-active');
      var type = x.dataset.type;
      if(type === activeType){
        x.classList.add('is-active');
        document.getElementById('pane-' + (type || 'all')).classList.remove('is-hidden');
      } else {
        document.getElementById('pane-' + (type || 'all')).classList.add('is-hidden');
      }
    });

    function showModal(){ modal.classList.remove('is-hidden'); }
    function hideModal(){ modal.classList.add('is-hidden'); }

    modal.addEventListener('click', function(e){
      if(e.target === modal){
        hideModal();
      }
    });

    btn.addEventListener('click', showModal);
    cancel.addEventListener('click', hideModal);

    tabs.forEach(function(t){
      t.addEventListener('click', function(){
        tabs.forEach(function(x){ x.classList.remove('is-active'); });
        t.classList.add('is-active');
        activeType = t.dataset.type;
        panes.forEach(function(p){ p.classList.add('is-hidden'); });
        document.getElementById('pane-' + (activeType || 'all')).classList.remove('is-hidden');
      });
    });

    function setButtonLabel(){
      var label = 'All';
      if(activeType === 'day' && dayInput.value){
        label = dayInput.value;
      } else if(activeType === 'month' && monthYearSelect.value && monthSelect.value){
        label = monthYearSelect.value + '-' + monthSelect.value;
      } else if(activeType === 'year' && yearSelect.value){
        label = yearSelect.value;
      } else if(activeType === 'range' && (startRange.value || endRange.value)){
        label = (startRange.value || '') + ' - ' + (endRange.value || '');
      } else if(activeType === 'last30'){
        label = 'Last 30 days';
      }
      dateLabel.textContent = label;
    }

    apply.addEventListener('click', function(){
      if(activeType === 'day' && dayInput.value){
        periodInput.value = 'custom';
        startInput.value = dayInput.value;
        endInput.value = dayInput.value;
      } else if(activeType === 'month' && monthYearSelect.value && monthSelect.value){
        periodInput.value = 'month-' + monthYearSelect.value + '-' + monthSelect.value;
        startInput.value = '';
        endInput.value = '';
      } else if(activeType === 'year' && yearSelect.value){
        periodInput.value = 'year-' + yearSelect.value;
        startInput.value = '';
        endInput.value = '';
      } else if(activeType === 'last30'){
        var endDt = new Date();
        var startDt = new Date();
        startDt.setDate(endDt.getDate() - 29);
        periodInput.value = 'last30';
        startInput.value = startDt.toISOString().slice(0,10);
        endInput.value = endDt.toISOString().slice(0,10);
      } else if(activeType === 'range' && (startRange.value || endRange.value)){
        periodInput.value = 'custom';
        startInput.value = startRange.value;
        endInput.value = endRange.value;
      } else {
        periodInput.value = '';
        startInput.value = '';
        endInput.value = '';
      }
      setButtonLabel();
      hideModal();
      if(form){ form.submit(); }
    });

    setButtonLabel();
  });
  </script>
{% if duplicates is defined %}
<script>
document.querySelectorAll('button[data-action]').forEach(btn => {
  btn.addEventListener('click', () => {
    const sid = btn.dataset.sid;
    const qid = btn.dataset.qid;
    const action = btn.dataset.action;
    fetch('{{ url_for('resolve_duplicate') }}', {
      method: 'POST',
      headers: {'Content-Type': 'application/x-www-form-urlencoded'},
      body: `shopify_id=${sid}&qbo_id=${qid}&action=${action}`
    }).then(r => r.json()).then(res => {
      if(res.success){
        const row = document.getElementById(`dup-${sid}-${qid}`);
        if(row) row.remove();
      }
    });
  });
});

document.querySelectorAll('button[data-unmatch]').forEach(btn => {
  btn.addEventListener('click', () => {
    const sid = btn.dataset.sid;
    const qid = btn.dataset.qid;
    fetch('{{ url_for('unmatch_duplicate') }}', {
      method: 'POST',
      headers: {'Content-Type': 'application/x-www-form-urlencoded'},
      body: `shopify_id=${sid}&qbo_id=${qid}`
    }).then(r => r.json()).then(res => {
      if(res.success){
        const row = btn.closest('tr');
        if(row) row.remove();
        location.reload();
      }
    });
  });
});
</script>
{% endif %}
{% endblock %}
