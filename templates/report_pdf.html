<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Report</title>
  <style>
    @page { size: A4 landscape; margin: 1cm; }
    body { margin: 0; color: #363636; font-size: 10pt; }
    .page-break { page-break-after: always; }
      /* set explicit height so xhtml2pdf scales the image */
      .logo { height: {{ logo_size }}px; }
    .logo-wrap {
      width: 100%;
      text-align: center;
      margin-bottom: 0.5rem;
      border: none;
    }
    .logo-wrap td {
      padding: 0;
      border: none;
    }
    {% set primary = primary_color or '#1976d2' %}
    {% set highlight = highlight_color or '#bbdefb' %}
    h1, h2, h3 { color: {{ primary }}; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border: 1px solid {{ highlight }}; padding: 4px; }
    th { background-color: {{ highlight }}; }
    .table.is-striped tbody tr:nth-child(odd) { background-color: {{ highlight }}; }
    .table.is-narrow th, .table.is-narrow td { padding: 2px; }
    .table.is-bordered { border: 1px solid {{ highlight }}; }
    .has-background-light { background-color: {{ highlight }}; }
    .has-text-weight-bold { font-weight: 700; }
    .has-text-right { text-align: right; }
    .has-text-success { color: #0f9d58; }
    .has-text-danger { color: #d93025; }
    .mt-4 { margin-top: 1rem; }
    .mt-5 { margin-top: 1.5rem; }
    .mb-5 { margin-bottom: 1.5rem; }
  </style>
</head>
<body>
  <table class="logo-wrap" style="page-break-inside: avoid;">
    <tr>
      <td>
        {% if branding_logo_url %}
        <img src="{{ branding_logo_url }}" alt="logo" class="logo" style="height: {{ logo_size }}px;">
        {% endif %}
      </td>
    </tr>
    <tr>
      <td><h1 style="margin:0;">{{ report_title or branding or 'Report' }}</h1></td>
    </tr>
  </table>
  {% if include_month_summary %}
  <h2>Last month sales by type ({{ last_month_label }})</h2>
  <table class="table is-fullwidth is-striped is-narrow is-bordered">
    <thead>
      <tr><th>Type</th><th>{{ last_month_label }} $</th><th>vs Last Year</th><th>Avg Month $</th><th>Best Month $</th></tr>
    </thead>
    <tbody>
    {% for r in last_rows %}
      <tr{% if r.type == 'Total' %} class="has-background-light has-text-weight-bold"{% endif %}>
        <td>{{ r.type }}</td>
        <td class="has-text-right">${{ "%.2f"|format(r.total) }}</td>
        <td class="has-text-right">{{ r.vs_last | trend }}</td>
        <td class="has-text-right">{{ ("$%.2f"|format(r.avg_month)) | trend(r.avg_month_sign) }}</td>
        <td class="has-text-right">{{ ("$%.2f"|format(r.best_month)) | trend(r.best_month_sign) }}</td>
      </tr>
    {% endfor %}
    </tbody>
  </table>
  {% endif %}

{% if include_month_details and has_month_details %}
{% for cat, rows in sku_details.items() %}
{% if rows %}
  <h3 class="mt-4">{{ labels[cat] }} Details ({{ last_month_label }})</h3>
  <table class="table is-fullwidth is-striped is-narrow is-bordered">
    <thead>
      <tr>
        <th>SKU</th><th>Yearly $</th><th>Yearly Qty</th><th>{{ last_month_label }} $</th><th>{{ last_month_label }} Qty</th><th>Avg Month $</th><th>Avg Qty</th><th>Last Year $</th><th>Best Month $</th><th>Best Qty</th>
      </tr>
    </thead>
    <tbody>
    {% for r in rows %}
      <tr>
        <td>{{ r.sku }}</td>
        <td class="has-text-right">${{ "%.2f"|format(r.year_total) }}</td>
        <td class="has-text-right">{{ "%.2f"|format(r.year_qty) }}</td>
        <td class="has-text-right">${{ "%.2f"|format(r.month_total) }}</td>
        <td class="has-text-right">{{ "%.2f"|format(r.month_qty) }}</td>
        <td class="has-text-right">{{ ("$%.2f"|format(r.avg_month)) | trend(r.avg_month_sign) }}</td>
        <td class="has-text-right">{{ ("%.2f"|format(r.avg_qty)) | trend(r.avg_qty_sign) }}</td>
        <td class="has-text-right">{{ ("$%.2f"|format(r.last_year)) | trend(r.last_year_sign) }}</td>
        <td class="has-text-right">{{ ("$%.2f"|format(r.best_month)) | trend(r.best_month_sign) }}</td>
        <td class="has-text-right">{{ ("%.2f"|format(r.best_qty)) | trend(r.best_qty_sign) }}</td>
      </tr>
    {% endfor %}
    </tbody>
  </table>
{% if not loop.last %}<div class="page-break"></div>{% endif %}
{% endif %}
{% endfor %}
{% if include_year_overall or include_year_summary %}<div class="page-break"></div>{% endif %}
{% elif include_year_overall or include_year_summary %}
<div class="page-break"></div>
{% endif %}

  {% if include_year_overall %}
  <h2 class="mt-5">Overall sales by month ({{ selected_year }})</h2>
  <table class="table is-fullwidth is-bordered mb-5">
    <thead>
      <tr><th>Month</th><th>{{ selected_year }} $</th><th>{{ selected_year - 1 }} $</th><th>% Change</th></tr>
    </thead>
    <tbody>
    {% for month, current, previous, pct in rows %}
      <tr>
        <td>{{ month }}</td>
        <td class="has-text-right">${{ "%.2f"|format(current or 0) }}</td>
        <td class="has-text-right">${{ "%.2f"|format(previous or 0) }}</td>
        <td class="has-text-right">{{ pct | trend }}</td>
      </tr>
    {% endfor %}
    </tbody>
  </table>
  {% if include_year_summary %}
  <div class="page-break"></div>
  {% endif %}
  {% endif %}

  {% if include_year_summary %}
  <h3>Yearly summary by type</h3>
  <table class="table is-fullwidth is-striped is-narrow is-bordered">
    <thead>
      <tr><th>Type</th><th>Total $</th><th>vs Last Year</th><th>Avg Month $</th><th>Best Month $</th><th>Avg Qty</th><th>Best Qty</th></tr>
    </thead>
    <tbody>
    {% for r in type_rows %}
      <tr>
        <td>{{ r.type }}</td>
        <td class="has-text-right">${{ "%.2f"|format(r.total) }}</td>
        <td class="has-text-right">{{ r.vs_last | trend }}</td>
        <td class="has-text-right">{{ ("$%.2f"|format(r.avg_month)) | trend }}</td>
        <td class="has-text-right">{{ ("$%.2f"|format(r.best_month)) | trend }}</td>
        <td class="has-text-right">{{ ("%.2f"|format(r.avg_qty)) | trend }}</td>
        <td class="has-text-right">{{ ("%.2f"|format(r.best_qty)) | trend }}</td>
      </tr>
    {% endfor %}
    </tbody>
  </table>
  {% endif %}
</body>
</html>
