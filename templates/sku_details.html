{% extends "layout.html" %}
{% block content %}
<div class="mdc-card">
  <div class="card-content">
    <h2 class="title is-4 mb-4">SKU drilldown</h2>
    <form method="get" class="mb-4 is-flex is-align-items-end">
      <div class="field mr-2">
        <label class="label">SKU</label>
        <div class="select">
          <select name="sku" onchange="this.form.submit()">
            <option value="">All</option>
            {% for opt in sku_options %}
            <option value="{{ opt }}" {% if opt == sku %}selected{% endif %}>{{ opt }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
      <div class="field mr-2">
        <label class="label">Upload</label>
        <div class="select">
          <select name="source" onchange="this.form.submit()">
            <option value="both" {% if source == 'both' %}selected{% endif %}>Both</option>
            <option value="shopify" {% if source == 'shopify' %}selected{% endif %}>Shopify</option>
            <option value="qbo" {% if source == 'qbo' %}selected{% endif %}>QBO</option>
          </select>
        </div>
      </div>
      <div class="field mr-2">
        <label class="label">Date</label>
        <div class="select">
          <select name="period" id="periodSelect" onchange="this.form.submit()">
            <option value="" {% if not period %}selected{% endif %}>All</option>
            {% for y in years %}
            <option value="year-{{ y }}" {% if period == ('year-' ~ y) %}selected{% endif %}>{{ y }}</option>
            {% endfor %}
            {% for m in month_options %}
            <option value="{{ m.value }}" {% if period == m.value %}selected{% endif %}>{{ m.label }}</option>
            {% endfor %}
            <option value="custom" {% if period == 'custom' %}selected{% endif %}>Custom range</option>
          </select>
        </div>
      </div>
      <div id="customRange" class="is-flex is-align-items-end mr-2" style="display:none;">
        <div class="field mr-2">
          <label class="label">Start</label>
          <input type="date" class="input" name="start" value="{{ start }}">
        </div>
        <div class="field mr-2">
          <label class="label">End</label>
          <input type="date" class="input" name="end" value="{{ end }}">
        </div>
      </div>
      <div class="field">
        <button class="mdc-button mdc-button--raised" type="submit">Filter</button>
      </div>
    </form>
    {% if sku %}
    <table class="table is-fullwidth is-striped is-narrow mb-4">
      <thead>
        <tr><th>Source</th><th>Quantity</th><th>Total $</th></tr>
      </thead>
      <tbody>
        {% if show_shopify %}
        <tr>
          <td>Shopify</td>
          <td>{{ "%.2f"|format(summary.shopify.quantity) }}</td>
          <td>${{ "%.2f"|format(summary.shopify.total) }}</td>
        </tr>
        {% endif %}
        {% if show_qbo %}
        <tr>
          <td>QBO</td>
          <td>{{ "%.2f"|format(summary.qbo.quantity) }}</td>
          <td>${{ "%.2f"|format(summary.qbo.total) }}</td>
        </tr>
        {% endif %}
      </tbody>
    </table>
    <table class="table is-fullwidth is-striped is-narrow">
      <thead>
        <tr>
          <th class="no-wrap">Date</th><th class="no-wrap">SKU</th><th>Description</th><th class="no-wrap">Price $</th><th class="no-wrap">Quantity</th><th class="no-wrap">Total $</th><th class="no-wrap">Source</th>
        </tr>
      </thead>
      <tbody>
        {% for row in rows %}
        <tr>
          <td class="no-wrap">{{ row.created_at|format_dt }}</td>
          <td class="no-wrap">{{ row.sku }}</td>
          <td>{{ row.description }}</td>
          <td class="no-wrap">{{ "%.2f"|format(row.price) }}</td>
          <td class="no-wrap">{{ "%.2f"|format(row.quantity) }}</td>
          <td class="no-wrap">${{ "%.2f"|format(row.total) }}</td>
          <td class="no-wrap">{{ row.source_title }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% endif %}
  </div>
</div>
<script>
  document.addEventListener('DOMContentLoaded', function(){
    var select = document.getElementById('periodSelect');
    var range = document.getElementById('customRange');
    function update(){
      var custom = select.value === 'custom';
      range.style.display = custom ? 'flex' : 'none';
      range.querySelectorAll('input').forEach(function(i){
        i.disabled = !custom;
      });
    }
    if(select){
      select.addEventListener('change', update);
      update();
    }
  });
</script>
{% endblock %}
