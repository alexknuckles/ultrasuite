{% extends "layout.html" %}
{% block content %}
<div class="mdc-card">
  <div class="card-content">
    <h2 class="title is-4 mb-4">SKU drilldown</h2>
    <form method="get" class="mb-4 filter-form">
      <div class="field mr-2">
        <label class="label">SKU</label>
        <div class="select">
          <select name="sku" onchange="this.form.submit()">
            <option value="">All</option>
            {% for opt in sku_options %}
            <option value="{{ opt }}" {% if opt == sku %}selected{% endif %}>{{ opt }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
      <div class="field mr-2">
        <label class="label">Upload</label>
        <div class="select">
          <select name="source" onchange="this.form.submit()">
            <option value="both" {% if source == 'both' %}selected{% endif %}>Both</option>
            <option value="shopify" {% if source == 'shopify' %}selected{% endif %}>Shopify</option>
            <option value="qbo" {% if source == 'qbo' %}selected{% endif %}>QBO</option>
          </select>
        </div>
      </div>
      <div class="field mr-2">
        <label class="label">Date</label>
        <div class="select">
          <select id="periodType">
            <option value="" {% if not period_type %}selected{% endif %}>All</option>
            <option value="year" {% if period_type == 'year' %}selected{% endif %}>Year</option>
            <option value="month" {% if period_type == 'month' %}selected{% endif %}>Month</option>
            <option value="custom" {% if period_type == 'custom' %}selected{% endif %}>Custom range</option>
          </select>
        </div>
      </div>
      <input type="hidden" name="period" id="periodInput" value="{{ period }}">
      <div id="yearContainer" class="field mr-2" style="display:none;">
        <label class="label">Year</label>
        <div class="select">
          <select id="yearSelect">
            {% for y in years %}
            <option value="{{ y }}" {% if period_year == (y|string) %}selected{% endif %}>{{ y }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
      <div id="monthContainer" class="field mr-2" style="display:none;">
        <label class="label">Month</label>
        <input type="month" id="monthInput" class="input" value="{{ period_month }}">
      </div>
      <div id="customRange" class="is-flex is-align-items-end mr-2" style="display:none;">
        <div class="field mr-2">
          <label class="label">Start</label>
          <input type="date" class="input" name="start" value="{{ start }}">
        </div>
        <div class="field mr-2">
          <label class="label">End</label>
          <input type="date" class="input" name="end" value="{{ end }}">
        </div>
      </div>
      <div class="field">
        <button class="mdc-button mdc-button--raised" type="submit">Filter</button>
      </div>
    </form>
    {% if sku %}
    <table class="table is-fullwidth is-striped is-narrow mb-4">
      <thead>
        <tr><th>Source</th><th>Quantity</th><th>Total $</th></tr>
      </thead>
      <tbody>
        {% if show_shopify %}
        <tr>
          <td>Shopify</td>
          <td>{{ "%.2f"|format(summary.shopify.quantity) }}</td>
          <td>${{ "%.2f"|format(summary.shopify.total) }}</td>
        </tr>
        {% endif %}
        {% if show_qbo %}
        <tr>
          <td>QBO</td>
          <td>{{ "%.2f"|format(summary.qbo.quantity) }}</td>
          <td>${{ "%.2f"|format(summary.qbo.total) }}</td>
        </tr>
        {% endif %}
      </tbody>
    </table>
    <table class="table is-fullwidth is-striped is-narrow">
      <thead>
        <tr>
          <th class="no-wrap">Date</th><th class="no-wrap">SKU</th><th>Description</th><th class="no-wrap">Price $</th><th class="no-wrap">Quantity</th><th class="no-wrap">Total $</th><th class="no-wrap">Source</th>
        </tr>
      </thead>
      <tbody>
        {% for row in rows %}
        <tr>
          <td class="no-wrap">{{ row.created_at|format_dt }}</td>
          <td class="no-wrap">{{ row.sku }}</td>
          <td>{{ row.description }}</td>
          <td class="no-wrap">{{ "%.2f"|format(row.price) }}</td>
          <td class="no-wrap">{{ "%.2f"|format(row.quantity) }}</td>
          <td class="no-wrap">${{ "%.2f"|format(row.total) }}</td>
          <td class="no-wrap">{{ row.source_title }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% endif %}
  </div>
</div>
<script>
  document.addEventListener('DOMContentLoaded', function(){
    var form = document.querySelector('form');
    var typeSelect = document.getElementById('periodType');
    var yearSelect = document.getElementById('yearSelect');
    var monthInput = document.getElementById('monthInput');
    var yearContainer = document.getElementById('yearContainer');
    var monthContainer = document.getElementById('monthContainer');
    var range = document.getElementById('customRange');
    var periodInput = document.getElementById('periodInput');

    function update(){
      var type = typeSelect.value;
      yearContainer.style.display = type === 'year' ? 'block' : 'none';
      monthContainer.style.display = type === 'month' ? 'block' : 'none';
      var custom = type === 'custom';
      range.style.display = custom ? 'flex' : 'none';
      range.querySelectorAll('input').forEach(function(i){
        i.disabled = !custom;
      });

      if(type === 'year'){
        periodInput.value = yearSelect.value ? 'year-' + yearSelect.value : '';
      } else if(type === 'month'){
        if(monthInput.value){
          var parts = monthInput.value.split('-');
          periodInput.value = 'month-' + parts[0] + '-' + parts[1];
        } else {
          periodInput.value = '';
        }
      } else if(type === 'custom'){
        periodInput.value = 'custom';
      } else {
        periodInput.value = '';
      }
    }

    function maybeSubmit(){
      update();
      if(form && typeSelect.value !== 'custom'){
        form.submit();
      }
    }

    if(typeSelect){
      [typeSelect, yearSelect, monthInput].forEach(function(el){
        if(el){ el.addEventListener('change', maybeSubmit); }
      });
      update();
    }
  });
</script>
{% endblock %}
